---
title: "Structural breack test on financial bubbles"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

Firstly we load all the necessary libraries and and functions.

```{r, message=FALSE}
library(exuber)
library(bestNormalize)
library(readr)
library(dplyr)
library(car)
library(glmnet)
library(factoextra)
library(ggfortify)
library(urca)
library(modelr)
library(epiDisplay)
library(blorr)
library(visreg)
library(gridExtra)
library(oddsratio)
library(tictoc)
library(zoo)
library(Rbeast)
library(psymonitor)
library(bbdetection)
library(rugarch)
library(devtools)
library(rbmi)
library(dplyr)
library(dqshiny)
library(ggplot2)
library(ghyp)
library(lubridate)
library(strucchange)
library(changepoint)
library(Rssa)
library(tidyr)
library(qcc)
library(corrplot)
library(cpm)
library(caret)
add_class <- function(x, ...) {
  class(x) <- append(c(...), class(x))
  x
}
```

Then, we load S&P500 daily returns from 10/03/1987 to 30/01/2009 to set up the model used to capture equity-market volatility asymmetry.

```{r}
#install_url('https://cran.r-project.org/src/contrib/Archive/psymonitor/psymonitor_0.0.2.tar.gz')
#install_url('https://cran.r-project.org/src/contrib/Archive/dqshiny/dqshiny_0.0.4.tar.gz')
add_class <- function(x, ...) {
  class(x) <- append(c(...), class(x))
  x
}
#DATA
#https://rdrr.io/rforge/rugarch/man/sp500ret.html
#https://rdrr.io/rforge/rugarch/man/dmbp.html
#data(dmbp)
data("sp500ret")
#auto.arima(sp500ret$SP500RET)
data_garch = sp500ret*100
#GARCH
spec <- ugarchspec(variance.model = list(model = "eGARCH",garchOrder = c(1,1))
                   ,distribution.model="ghyp")
fit = ugarchfit(data = data_garch , spec = spec)

#residuals
garch_resid <- residuals(fit, standardize = FALSE)
# extract standardized residuals
garch_resid_std <- residuals(fit, standardize = TRUE)
# standardized residuals to be used in ugarchsim()
custom_dist = list(
  name = "sample",
  distfit = matrix(garch_resid_std,  ncol = 1)
)

m_ <- fit@model$maxOrder

garch_sim <- ugarchsim(fit, 
                       n.sim = length(garch_resid_std),
                       m.sim = 1, 
                       presigma = tail(fit@fit$sigma, m_),
                       prereturns = tail(sp500ret, m_),
                       # preresiduals ARE NOT standardized:
                       preresiduals = tail(garch_resid, m_),
                       startMethod = "sample",
                       # distfit in custom.dist ARE standardized
                       custom.dist = custom_dist)

# extract simulated series
sp_sim <- garch_sim@simulation$seriesSim
# test
sp_df <- cbind(sp500ret, sim = sp_sim) %>% 
  setNames(c("ret", "sim")) %>% 
  as_tibble(rownames = "date") %>% 
  mutate(date = as.Date(date),
         diff = sim - ret)

egarch<-function(n_sim) {
  #custom_dist = list(
  # name = "sample",
  #distfit = matrix(garch_resid_std[1:n_sim,],  ncol = 1)
  #)
  
  garch_sim <- ugarchsim(fit, 
                         n.sim = n_sim,
                         m.sim = 1, 
                         presigma = tail(fit@fit$sigma, m_),
                         prereturns = tail(sp500ret, m_),
                         # preresiduals ARE NOT standardized:
                         preresiduals = tail(garch_resid, m_),
                         startMethod = "sample",
                         # distfit in custom.dist ARE standardized
                         #custom.dist = custom_dist
                         )
  values = as.numeric(garch_sim@simulation$seriesSim)
  #remove(custom_dist)
  return(values)
}
```

After, we create the bubbles as proposed in (article).

```{r}
bubble <- function(n, te = 0.4 * n, tf = te + 0.2 * n , tr = tf + 0.1*n,
                   c = 1, c1 = 1, c2 = 1, eta = 0.6, alpha = 0.6, beta = 0.5) {
  
  drift <- c*n^(-eta)
  delta <- 1 + c1 * n^(-alpha)
  gamma <- 1 - c2 * n^(-beta)
  y <- 100
  err <- egarch(n)
  
  for (t in 2:n) {
    if (t < te) {
      y[t] <- drift + y[t - 1] + err[t]
    } else if (t >= te & t <= tf) {
      y[t] <- delta * y[t - 1] + err[t]
    } else if (t > tf & t <= tr ) {
      y[t] <- gamma * y[t - 1] + err[t]
    } else {
      y[t] <- drift + y[t - 1] + err[t]
    }
  }
  y %>%
    add_class("sim") 
}


bubble_2 <- function(n,
                    te1 = 0.3 * n, tf1 = te1 + 0.1 * n , tr1 = tf1 + 0.1*n,
                    te2 = 0.8 * n, tf2 = te2 + 0.1 * n , tr2 = tf2 + 0.1*n,
                    c = 1, c1 = 1, c2 = 1, eta = 0.6, alpha = 0.6, beta = 0.7) {
  
  drift <- c*n^(-eta)
  delta <- 1 + c1 * n^(-alpha)
  gamma <- 1 - c2 * n^(-beta)
  y <- 100
  err <- egarch(n)
  
  for (t in 2:n) {
    if (t < te1) {
      y[t] <- drift + y[t - 1] + err[t] # normal
    } else if (t >= te1 & t <= tf1) {
      y[t] <- delta * y[t - 1] + err[t] # bubble1
    } else if (t > tf1 & t <= tr1 ) {
      y[t] <- gamma * y[t - 1] + err[t] # collapse 1
    }  else if (t > tr1 + 1 & t < te2) {
      y[t] <- drift + y[t - 1] + err[t] # normal 2
    }  else if (t >= te2 + 1 & t <= tf2) {
      y[t] <- delta * y[t - 1] + err[t] # bubble 2
    }  else if (t > tf2 + 1 & t <= tr2) {
      y[t] <- gamma * y[t - 1] + err[t] # collapse 2
    } else {
      y[t] <- drift + y[t - 1] + err[t] # normal 3
    }
  }
  y %>%
    add_class("sim")
}

set.seed(000)
time = 100
disturbing <- bubble(time, te = time*0.4, tf= time*0.6, tr = time*0.7, beta = 0.5, alpha = 0.6)
sudden <- bubble(time, time*0.3, tf= time*0.5, tr = time*0.51, beta = 0.15, alpha = 0.6, eta = 0.03)
smooth <- bubble(time, time*0.4, tf= time*0.6, tr = time*0.8, beta = 0.9, alpha = 0.6)
```

In the following there are the plots.

```{r}
autoplot(disturbing)
autoplot(smooth)
autoplot(sudden)

plot(1:99,diff(log(smooth)),type='l')
plot(1:99,diff(log(disturbing)),type='l')
plot(1:99,diff(log(sudden)),type='l')

plot(1:99,abs(diff(log(smooth))),type='l')
plot(1:99,abs(diff(log(disturbing))),type='l')
plot(1:99,abs(diff(log(sudden))),type='l')
```

Now, we can compare the two test using the disturbing bubble.

```{r}
#TEST
sp500ret$data <- row.names(sp500ret)
sp500ret$data <- ymd(sp500ret$data)

series <- abs(diff(log(disturbing)))
              
test <- processStream(series,"Kolmogorov-Smirnov",ARL0=5000, startup=20)
plot(1:length(series),series, type = "l", xlab = "Observation", ylab = "", bty = "l")
abline(v = test$detectionTimes, col = 'blue')
abline(v = test$changePoints, lty = 2, col = 'red')
test

series <- abs(diff(log(smooth)))
              
test <- processStream(series,"Kolmogorov-Smirnov",ARL0=5000, startup=20)
plot(1:length(series),series, type = "l", xlab = "Observation", ylab = "", bty = "l")
abline(v = test$detectionTimes, col = 'blue')
abline(v = test$changePoints, lty = 2, col = 'red')
test

series <- abs(diff(log(sudden)))
              
test <- processStream(series,"Kolmogorov-Smirnov",ARL0=5000, startup=20)
plot(1:length(series),series, type = "l", xlab = "Observation", ylab = "", bty = "l")
abline(v = test$detectionTimes, col = 'blue')
abline(v = test$changePoints, lty = 2, col = 'red')
test

ewma <- numeric(length(series))
ewma[1] <- series[1]^2
lambda <- 0.94
for (i in 2:length(ewma)){
  ewma[i] <- lambda * ewma[i - 1] + (1 - lambda) * series[i]^2
}
plot(ewma, type = "l", xlab = "Observation", ylab = "", bty = "l")

abline(v = test$changePoints, lty = 2)

radf_sim <- radf(ts(disturbing))
autoplot(radf_sim)
datestamp(radf_sim)
```

In the following we will run the simulations.

```{r}
#Distirubing(40,70)

matrix_empty = matrix(nrow = 100, ncol = 1000)

set.seed(002)
cyc = c(1:1000)
DIS <- data.frame(matrix_empty)
for (i in cyc){
  DIS[,i] <- bubble(time, te = time*0.4, tf= time*0.6, tr = time*0.7, beta = 0.5, alpha = 0.6)
}

results_DIS <- list()
ADF_DIS <- list()
for (i in cyc){
  tryCatch({ss <- abs(diff(log(DIS[,i])))
  test <- processStream(ss,"Kolmogorov-Smirnov",ARL0=5000, startup=20)
  results_DIS[[i]]<-test$changePoint
  remove(test)
  radf_sim <- radf(ts(DIS[,i]))
  d<-datestamp(radf_sim)
  ADF_DIS[[i]] <- c(d$series1$Start,d$series1$End)
  remove(d)
  remove(radf_sim)
  print(i)
},error=function(e){cat('ERROR:',conditionMessage(e),'\n')})}
results_DIS
ADF_DIS
correct<-length(results_DIS[lengths(results_DIS) == 3])
correct_ADF<-length(ADF_DIS[lengths(ADF_DIS) == 2])
#968/962
#849
```

Regarding the disturbing bubble our test recognize correctly 95/100, while ADF 86/100. Our test is also more accurate to detect the end and initial point of the bubble.

```{r}
#Sudden(30,51)
set.seed(003)
SUD <- data.frame(matrix_empty)
for (i in cyc){
  SUD[,i] <- c(bubble(time, time*0.3, tf= time*0.5, tr = time*0.51, beta = 0.15, alpha = 0.6))
}

results_SUD <- list()
ADF_SUD <- list()
for (i in cyc){
  tryCatch({ss <- abs(diff(log(SUD[,i])))
  test <- processStream(ss,"Kolmogorov-Smirnov",ARL0=5000, startup=20)
  results_SUD[[i]]<-test$changePoints
  remove(test)
  radf_sim <- radf(ts(SUD[,i]))
  d<-datestamp(radf_sim)
  ADF_SUD[[i]] <- c(d$series1$Start,d$series1$End)
  remove(d)
  remove(radf_sim)
  print(i)
  },error=function(e){cat('ERROR:',conditionMessage(e),'\n')})}
results_SUD
correct<-length(results_SUD[lengths(results_SUD) == 2])
correct_ADF<-length(ADF_SUD[lengths(ADF_SUD) == 2])
ADF_SUD

#940/931
#855
```

Regarding the sudden bubble our test recognize correctly 90/100, while ADF 87/100. The test seems to be accurate at the same level.

```{r}
#Smooth(40,80)
set.seed(004)
SMO <- data.frame(matrix_empty)
for (i in cyc){
  SMO[,i] <- c(bubble(time, time*0.4, tf= time*0.6, tr = time*0.8, beta = 0.9, alpha = 0.6))
}

results_SMO <- list()
ADF_SMO <- list()
for (i in cyc){
  tryCatch({ss <- abs(diff(log(SMO[,i])))
  test <- processStream(ss,"Kolmogorov-Smirnov",ARL0=5000, startup=20)
  results_SMO[[i]]<-test$changePoints
  remove(test)
  radf_sim <- radf(ts(SMO[,i]))
  d<-datestamp(radf_sim)
  ADF_SMO[[i]] <- c(d$series1$Start,d$series1$End)
  remove(d)
  remove(radf_sim)
  print(i)
},error=function(e){cat('ERROR:',conditionMessage(e),'\n')})}
results_SMO
correct<-length(results_SUD[lengths(results_SMO) == 3])
correct_ADF<-length(ADF_SUD[lengths(ADF_SMO) == 2])
ADF_SMO
#895
#848
```

Regarding the disturbing bubble our test recognize correctly 87/100, while ADF 83/100. Our test is also more accurate to detect the end and initial point of the bubble.

An alternative and suitable approach is also given in the Bayesian field.

```{r}
series<-abs(diff(log(sudden)))
out = beast(series, season = 'none', precPriorType = 'uniform', mcmc.chains = 10, mcmc.samples = 10000, mcmc.seed = 002, mcmc.burning  = 1000)
plot(out)
```

```{r}
series<-abs(diff(log(disturbing)))
out = beast(series, season = 'none', precPriorType = 'uniform', mcmc.chains = 10, mcmc.samples = 10000, mcmc.seed = 003, mcmc.burning  = 1000)
plot(out)
```

```{r}
series<-abs(diff(log(smooth)))
out = beast(series, season = 'none', precPriorType = 'uniform', mcmc.chains = 10, mcmc.samples = 10000, mcmc.seed = 003, mcmc.burning  = 1000)
plot(out)
```

Now, we will test all three approaches on real data, that is S&P500.

```{r}
#S&P500
SP500 <- as.data.frame(sp500m)
SP500$Date <- row.names(SP500)
SP500$Date <- ymd(SP500$Date)
ggplot(SP500, aes(Date, SP500))+geom_line()
series <- abs(diff(log(SP500$SP500)))
#plot(SP500$Date[2:840],series, type='l')
ggplot(SP500[2:840,], aes(Date,series))+geom_line()+ggtitle('S&P500')+xlab('Time')+ylab('Absolute Returns')
```

Firstly the non-parametric test.

```{r}
tic('Time to run')
test <- processStream(series,"Kolmogorov-Smirnov", ARL0=10000, startup=20)
breack<-SP500$Date[test$changePoints]
plot(SP500$Date, SP500$SP500, type = "l", xlab = "Observation", ylab = "", bty = "l")
#abline(v = test$detectionTimes, col = 'blue')
abline(v = breack, lty = 2, col = 'red')
test

ewma <- numeric(length(series))
ewma[1] <- series[1]^2
lambda <- 0.94
for (i in 2:length(ewma)){
  ewma[i] <- lambda * ewma[i - 1] + (1 - lambda) * series[i]^2
}
plot(SP500$Date[2:840], ewma, type = "l", xlab = "Observation", ylab = "", bty = "l")
abline(v = breack, lty = 2, col = 'red')
toc()
```

Then the Bayesian test.

```{r}
tic('Time to run')
series<-ts(series,frequency=12,start=c(1950,1))
out = beast(series, season = 'none', precPriorType = 'uniform', mcmc.chains = 10, mcmc.samples = 10000, mcmc.seed = 002, mcmc.burning  = 1000)
plot(out)
toc()
```

Finally the SADF test.

```{r}
tic('Time to run')
series<-ts(SP500$SP500,frequency=12,start=c(1950,1))
crit_values_sp<-radf_mc_cv(length(SP500$SP500), seed = 0005)
radf_sim <- radf(series)
datestamp(radf_sim, crit_values_w)
autoplot(radf_sim, crit_values_w)
toc()
```

How we can see the both Bayesian test and non-parametric test identify the dot-com bubble and the housig bubble. However, only the Bayesian test was able to identify the oil shock, and the black Monday of 1987. On the other hand, the SADFT show similar but not so clear results.

# RENNIX

In the following we found the daily value of the time series of th RENNIX index.

```{r}
renixx <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/renixx_3.csv")

#DESCRIPTIVE STATISTICS

renixx$date<-ymd(renixx$date)
ggplot(renixx, aes(date, close))+geom_line()+ggtitle('Renixx index')+xlab('Time')+ylab('Absolute Returns')
```

```{r}
#renixx <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/renixx.csv")
renixx$date<-ymd(renixx$date)
df <- renixx %>% dplyr::select(1,3)
df$abs <- abs(c(0,diff(log(df$close))))
ggplot(df, aes(date, abs))+geom_line()
```

From here on we will work with weekly data.

```{r}
Month<- as.Date(cut(df$date, "month"))
renixx_m <- aggregate(close ~ Month, df, mean)
renixx_m<-renixx_m[13:228,]
rownames(renixx_m)<-NULL
renixx_m$abs <- c(0,abs(diff(log(renixx_m$close))))

#Boxcox
#bc_obj<-boxcox(renixx_m$close[135:216])
#distBCMod<-BoxCoxTrans(renixx_m$close)
#distBCMod$lambda
#renixx_m$Renixx <- c(0,diff(predict(bc_obj)))
#renixx_m$Renixx <- c(0,diff(renixx_m$close))
renixx_m$Renixx <- c(0,diff(log(renixx_m$close)))
renixx_m$St<-log(renixx_m$close)
ggplot(renixx_m, aes(Month, abs))+geom_line()+xlab('Time')+ylab('Absolute Returns')+ggtitle('Renixx index')
ggplot(renixx_m, aes(Month, close))+geom_line()+xlab('Time')+ylab('Value')+ggtitle('Renixx index')
```

```{r}
test <- processStream(renixx_m$abs,"Kolmogorov-Smirnov", ARL0=10000, startup=42) #20% initial sample
breack<-renixx_m$Month[test$changePoints]
plot(renixx_m$Month, renixx_m$close, type = "l", xlab = "Observation", ylab = "", bty = "l")
#abline(v = test$detectionTimes, col = 'blue')
abline(v = breack, lty = 2, col = 'red')
test
```

```{r}
series<-ts(renixx_m$abs,frequency=12,start=c(2005,01,01))
out = beast(series, season = 'none', precPriorType = 'uniform', mcmc.chains = 10, mcmc.samples = 10000, mcmc.seed = 001, mcmc.burning  = 1000)
plot(out)
```

#Explosive behaviours

```{r}
set.seed(123)
series <- ts(renixx_m[,c(2,4)],frequency=12,start=c(2005,1))
crit_values_r <- radf_mc_cv(nrow(series), seed = 001)
results<-radf(series[,1])
autoplot(results)+labs(title = "Renixx BSADF")
d_adf<-datestamp(results)
d_adf
```

#Descriptive statistics

Now, we add the other variables

```{r}
#Oil WTI Futures
Oil <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Crude Oil WTI Futures Historical Data_2005.csv")
Oil$Date <- mdy(Oil$Date)
Month <- as.Date(cut(Oil$Date, "month"))
Oil_m <- aggregate(Price ~ Month, Oil, mean)

#BoxCox
#distBCMod<-BoxCoxTrans(Oil_m$Price)
#distBCMod$lambda
#bc_obj<-boxcox(Oil_m$Price)
#Oil_m$Rate_O<-c(0,diff(predict(bc_obj)))
Oil_m$Rate_O<-c(0,diff(log(Oil_m$Price)))
Oil_m$Rate_s<-scale(c(0,diff(Oil_m$Price)),scale=TRUE,center=TRUE)
rownames(Oil_m)<-NULL
ggplot(Oil_m, aes(Month, Price))+geom_line()+ggtitle('Oil price')
```

```{r}
#Geopolitical index 
library(readxl)
data_gpr_export <- read_excel("~/GitHub/PhD-Thesis/Poject paper 1/data_gpr_daily_recent.xls")
geo_i <- data_gpr_export %>% dplyr::select(6,3)
#remove(data_gpr_export)
colnames(geo_i)[1] <- "Date"
geo_i2 <- geo_i[geo_i$Date <= "2022-12-30" & geo_i$Date >= "2005-01-01", ]

Month <- as.Date(cut(geo_i2$Date, "month"))
geo_m <- aggregate(geo_i2$GPRD ~ Month,geo_i2, mean)
colnames(geo_m)[2] <- "GPRH"
geo_m$GPRH<-as.numeric(geo_m$GPRH)

#BoxCox
#distBCMod<-BoxCoxTrans(geo_m$GPRH)
#distBCMod$lambda
#bc_obj<-boxcox(geo_m$GPRH)
#geo_m$Rate_g <- c(0,diff(predict(bc_obj)))
geo_m$Rate_g <- c(0,diff(log(geo_m$GPRH)))
geo_m$St <- scale(c(0,diff(geo_m$GPRH)),scale=TRUE,center=TRUE)
ggplot(geo_m, aes(Month, GPRH))+geom_line()+ggtitle('Geopolitical index')
```

```{r}
#MSCI_WORLD
library(caret)
MSCI<-read_csv("MSCI World_2005.csv")
MSCI_2 <- MSCI %>% dplyr::select(6,2)
MSCI_2$Date <- format(as.Date(MSCI_2$Date,format='%m/%d/%y'), "%m/%d/%Y")
MSCI_2$Date <- mdy(MSCI_2$Date)

Month <- as.Date(cut(MSCI_2$Date, "month"))
MSCI_2$Close<-as.numeric(MSCI_2$Close)
MSCI_m <- aggregate(Close ~ Month, MSCI_2, mean)
colnames(MSCI_m)[2] <- "Price"
MSCI_m$Price<-as.numeric(MSCI_m$Price)
#BoxCox
#distBCMod<-BoxCoxTrans(MSCI_m$Price)
#distBCMod$lambda
#bc_obj<-boxcox(MSCI_m$Price)
#MSCI_m$Rate_ms <- c(0,diff(predict(bc_obj)))
MSCI_m$Rate_ms <- c(0,diff(log(MSCI_m$Price)))
MSCI_m$Rate_s <- scale(c(0,diff(MSCI_m$Price)),scale=TRUE,center=TRUE)
ggplot(MSCI_m, aes(Month, Price))+geom_line()+ggtitle('Global MSCI index')
```

```{r}
#Policy risk and Financial risk
GEPUCURRENT <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/GEPUCURRENT.csv")
GEPUCURRENT$DATE<-ymd(GEPUCURRENT$DATE)
GEPUCURRENT<-GEPUCURRENT[97:312,]
rownames(GEPUCURRENT) <- NULL
#BoxCox
#distBCMod<-BoxCoxTrans(GEPUCURRENT$GEPUCURRENT)
#distBCMod$lambda
#bc_obj<-boxcox(GEPUCURRENT$GEPUCURRENT)
#GEPUCURRENT$Rate<-c(0,diff(predict(bc_obj)))
GEPUCURRENT$Rate<-c(0,diff(log(GEPUCURRENT$GEPUCURRENT)))
GEPUCURRENT$Rate_s<-scale(c(0,diff(GEPUCURRENT$GEPUCURRENT)),scale=TRUE,center=TRUE)

Fs<-read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Fs.csv")
Month<- as.Date(cut(ymd(Fs$Date), "month"))
Fs_m <- aggregate(OFR.FSI ~ Month, Fs, mean)
Fs_m<-Fs_m[61:276,]
#distBCMod<-BoxCoxTrans(Fs_m$OFR.FSI)
Fs_m$Rate<-c(0,diff(Fs_m$OFR.FSI))
Fs_m$Rate_s<-scale(c(0,diff(Fs_m$OFR.FSI)),scale=TRUE,center=TRUE)
ggplot(Fs_m, aes(Month, OFR.FSI))+geom_line()+ggtitle('Financial Stability')
ggplot(GEPUCURRENT, aes(DATE, GEPUCURRENT))+geom_line()+ggtitle('Policy Uncertainty')
```

# What happens inside different phases

```{r}
Finance<-renixx_m[,c(1,4)]
colnames(Finance)[2] <- "Renixx"


Finance$Oil_p<-Oil_m$Rate_O


Finance$MSCI<-MSCI_m$Rate_ms


Finance$EPU<-GEPUCURRENT$Rate

Finance$OFR<-Fs_m$Rate

Finance$Geo_i<-geo_m$Rate_g

Finance_2<-renixx_m[,c(1,2)]
colnames(Finance_2)[2] <- "Renixx"
Finance_2$Renixx<-scale(Finance_2$Renixx,center=TRUE,scale=TRUE)
Finance_2$Oil_p<-scale(Oil_m$Price,center=TRUE,scale=TRUE)
Finance_2$Geo_i<-scale(geo_m$GPRH,center=TRUE,scale=TRUE)
Finance_2$MSCI<-scale(MSCI_m$Price,center=TRUE,scale=TRUE)
Finance_2$EPU<-scale(GEPUCURRENT$GEPUCURRENT,center=TRUE,scale=TRUE)
Finance_2$OFR<-scale(Fs_m$OFR.FSI,center=TRUE,scale=TRUE)


ggplot() + 
  geom_line(data = Finance_2, aes(x = Month, y = Renixx, color = "Rennix")) +
  geom_line(data = Finance_2, aes(x = Month, y = MSCI, color = "Global MSCI")) +
  geom_line(data = Finance_2, aes(x = Month, y = Geo_i, color = "Geopolitical index")) +
  geom_line(data = Finance_2, aes(x = Month, y = Oil_p, color = "Oil price")) +
  geom_line(data = Finance_2, aes(x = Month, y = EPU, color = "EPU")) +
  geom_line(data = Finance_2, aes(x = Month, y = OFR, color = "OFR")) +
  xlab('data_date') + ggtitle('Financial time series')+
  ylab('Monthly series')+ scale_color_manual(name='Series',
                     breaks=c('Rennix', 'Global MSCI','Geopolitical index','Oil price','EPU','OFR'),
                     values=c('Rennix'='green', 'Global MSCI'='red','Geopolitical index'='blue','Oil price'='brown','EPU'='orange','OFR'='grey'))

```

```{r}
#Text analysis
 
green_e <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Green_energy.csv", header=TRUE, comment.char="#")[13:228,]
green_e$Time<-ymd(green_e$Time)

#BoxCox
#distBCMod<-BoxCoxTrans(green_e$Absolute.Google.Search.Volume)
#distBCMod$lambda
#bc_obj<-boxcox(green_e$Absolute.Google.Search.Volume)
#green_e$Rate<-c(0,diff(predict(bc_obj)))
green_e$Rate<-c(0,diff(log(green_e$Absolute.Google.Search.Volume)))
Climate<-as.data.frame(green_e[,1]) 
colnames(Climate)[1] <- "Date"
Climate$Green_e<-green_e[,4]

Tech_d <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Tech.csv", header=TRUE, comment.char="#")[13:228,]
#distBCMod<-BoxCoxTrans(Tech_d$Absolute.Google.Search.Volume)
#distBCMod$lambda
#Tech_d$Rate<-c(0,diff(predict(distBCMod, Tech_d$Absolute.Google.Search.Volume)))
Tech_d$Rate<-c(0,diff(log(Tech_d$Absolute.Google.Search.Volume)))
#bc_obj<-boxcox(Tech_d$Absolute.Google.Search.Volume)
#Tech_d$Rate<-c(0,diff(predict(bc_obj)))
Climate$Tech<-Tech_d[,4]

Energy_i <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Energy_index.csv", header=TRUE, comment.char="#")[13:228,]

Energy_i<-Energy_i[,c(1,2,3)]
#distBCMod<-BoxCoxTrans(Energy_i$Absolute.Google.Search.Volume)
#distBCMod$lambda
#bc_obj<-boxcox(Energy_i$Absolute.Google.Search.Volume)
#Energy_i$Rate<-c(0,diff(predict(bc_obj)))
#Energy_i$Rate<-c(0,diff(predict(distBCMod, Energy_i$Absolute.Google.Search.Volume)))
Energy_i$Rate<-c(0,diff(log(Energy_i$Absolute.Google.Search.Volume)))
Climate$Energy_i<-Energy_i[,4]

global_w <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Global_warming.csv", header=TRUE, comment.char="#")[13:228,]
#distBCMod<-BoxCoxTrans(global_w$Absolute.Google.Search.Volume)
#distBCMod$lambda
#bc_obj<-boxcox(global_w$Absolute.Google.Search.Volume)
#global_w$Rate<-c(0,diff(predict(bc_obj)))
#global_w$Rate<-c(0,diff(predict(distBCMod, global_w$Absolute.Google.Search.Volume)))
global_w$Rate<-c(0,diff(log(global_w$Absolute.Google.Search.Volume)))
Climate$Warming<-global_w[,4]

Natural <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Natural_disasters.csv", header=TRUE, comment.char="#")[13:228,]
#distBCMod<-BoxCoxTrans(Natural$Absolute.Google.Search.Volume)
#bc_obj<-boxcox(Natural$Absolute.Google.Search.Volume)
#Natural$Rate<-c(0,diff(predict(bc_obj)))
#Natural$Rate<-c(0,diff(predict(distBCMod, Natural$Absolute.Google.Search.Volume)))
#distBCMod$lambda
Natural$Rate<-c(0,diff(log(Natural$Absolute.Google.Search.Volume)))
Climate$Natural<-Natural[,4]

Carbon_p <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Carbon_price.csv", header=TRUE, comment.char="#")[13:228,]
#distBCMod<-BoxCoxTrans(Carbon_p$Absolute.Google.Search.Volume)
#distBCMod$lambda
#Carbon_p$Rate<-c(0,diff(predict(distBCMod, Carbon_p$Absolute.Google.Search.Volume)))
Carbon_p$Rate<-c(0,diff(log(Carbon_p$Absolute.Google.Search.Volume)))
#bc_obj<-boxcox(Carbon_p$Absolute.Google.Search.Volume)
#Carbon_p$Rate<-c(0,diff(predict(bc_obj)))
Climate$Carbon_p<-Carbon_p[,4]

Tax <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Carbon_tax.csv", header=TRUE, comment.char="#")[13:228,]
#distBCMod<-BoxCoxTrans(Tax$Absolute.Google.Search.Volume)
#Tax$Rate<-c(0,diff(predict(distBCMod, Tax$Absolute.Google.Search.Volume)))
#distBCMod$lambda
Tax$Rate<-c(0,diff(log(Tax$Absolute.Google.Search.Volume)))
#bc_obj<-boxcox(Tax$Absolute.Google.Search.Volume)
#Tax$Rate<-c(0,diff(predict(bc_obj)))
Climate$Tax<-Tax[,4]

Energy_s <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Energy_shares.csv", header=TRUE, comment.char="#")[13:228,]
#distBCMod<-BoxCoxTrans(Energy_s$Absolute.Google.Search.Volume)
#distBCMod$lambda
#Energy_s$Rate<-c(0,diff(predict(distBCMod, Energy_s$Absolute.Google.Search.Volume)))
Energy_s$Rate<-c(0,diff(log(Energy_s$Absolute.Google.Search.Volume)))
#bc_obj<-boxcox(Energy_s$Absolute.Google.Search.Volume)
#Energy_s$Rate<-c(0,diff(predict(bc_obj)))
Climate$Energy_s<-Energy_s[,4]

Climate_2$Green_e<-scale(as.numeric(green_e[,3]),center = TRUE,scale=TRUE)
Climate_2$Tech<-scale(as.numeric(Tech_d[,3]),center = TRUE,scale=TRUE)
Climate_2$Warming<-scale(as.numeric(global_w[,3]),center = TRUE,scale=TRUE)
Climate_2$Energy_i<-scale(as.numeric(Energy_i[,3]),center = TRUE,scale=TRUE)
Climate_2$Natural<-scale(as.numeric(Natural[,3]),center = TRUE,scale=TRUE)
Climate_2$Carbon_p<-scale(as.numeric(Carbon_p[,3]),center = TRUE,scale=TRUE)
Climate_2$Energy_s<-scale(as.numeric(Energy_s[,3]),center = TRUE,scale=TRUE)
Climate_2$Energy_T<-scale(as.numeric(Energy_s[,3]+Energy_i[,3])/2,center = TRUE,scale=TRUE)
Climate_2$Energy_s<-scale(as.numeric(Energy_s[,3]),center = TRUE,scale=TRUE)
Climate_2$Tax<-scale(as.numeric(Tax[,3]),center = TRUE,scale=TRUE)

ggplot() + 
  geom_line(data = Climate_2, aes(x = Date, y = Green_e, color = "Green Energy")) +
  geom_line(data = Climate_2, aes(x = Date, y = Energy_i, color = "Energy Index")) +
  geom_line(data = Climate_2, aes(x = Date, y = Warming, color = "Global Warming")) +
  geom_line(data = Climate_2, aes(x = Date, y = Natural, color = "Natural Disasters"))+ 
  geom_line(data = Climate_2, aes(x =Date, y = Carbon_p, color = "Carbon price")) +
 geom_line(data = Climate_2, aes(x =Date, y = Energy_s, color = "Energy shares")) +
  geom_line(data = Climate_2, aes(x =Date, y = Tax, color = "Carbon Tax")) +
  geom_line(data = Climate_2, aes(x =Date, y = Tech, color = "New Technology")) +
  xlab('data_date') + ggtitle('Text-time series')+
  ylab('Monthly series')+ scale_color_manual(name='Series',
                     breaks=c('Green Energy', 'Global Warming','Natural Disasters','Carbon price',"New Technology",'Energy Index','Green Bond','Carbon Emissions','Energy shares','Carbon Tax'),
                     values=c('Green Energy'='green','Global Warming'='red', 'Natural Disasters'='gold','Carbon price'='brown','New Technology'='purple','Energy Index'='blue','Carbon Emissions'='orange','Energy shares'='violet','Carbon Tax'='grey'))
```

```{r}
#Stationary assumption of log-returns
library(lmtest)
library(tseries)
library(urca)
library(TSA)
library(fGarch)
library(fpp)

summary(ur.df(Climate[,"Carbon_p"], type = "drift",lags = 12, selectlags = "AIC"))
summary(ur.df(Climate[,"Green_e"], type = "drift",lags = 12, selectlags = "AIC"))
summary(ur.df(Climate[,"Tech"], type = "drift",lags = 12, selectlags = "AIC"))
summary(ur.df(Climate[,"Warming"], type = "drift",lags = 12, selectlags = "AIC"))
summary(ur.df(Climate[,"Natural"], type = "drift",lags = 12, selectlags = "AIC"))
summary(ur.df(Climate[3:216,"Tax"], type = "drift",lags = 12, selectlags = "AIC"))
summary(ur.df(Climate[,"Energy_s"], type = "drift",lags = 12, selectlags = "AIC"))
summary(ur.df(Climate[,"Energy_i"], type = "drift",lags = 12, selectlags = "AIC"))

summary(ur.df(Finance[,"Oil_p"], type = "drift",lags = 12, selectlags = "AIC"))
summary(ur.df(Finance[,"Renixx"], type = "drift",lags = 12, selectlags = "AIC"))
summary(ur.df(Finance[3:216,"MSCI"], type = "drift",lags = 12, selectlags = "AIC"))
summary(ur.df(Finance[,"EPU"], type = "drift",lags = 12, selectlags = "AIC"))
summary(ur.df(Finance[3:216,"OFR"], type = "drift",lags = 12, selectlags = "AIC"))
summary(ur.df(Finance[,"Geo_i"], type = "drift",lags = 12, selectlags = "AIC"))

kpss.test(Climate[,"Carbon_p"])
kpss.test(Climate[,"Tech"])
kpss.test(Climate[,"Natural"])
kpss.test(Climate[,"Green_e"])
kpss.test(Climate[,"Warming"])
kpss.test(Climate[,"Energy_s"])
kpss.test(Climate[,"Tax"])
kpss.test(Climate[,"Energy_i"])
kpss.test(Finance[,"Oil_p"])
kpss.test(Finance[,"Renixx"])
kpss.test(Finance[,"MSCI"])
kpss.test(Finance[,"Geo_i"])
kpss.test(Finance[,"EPU"])
kpss.test(Finance[,"OFR"])

#bptest(lm(Finance[,"Renixx"][-1]~ Finance[,"Renixx"][-length(Finance[,"Renixx"])]))
#bptest(lm(Finance[3:216,"MSCI"][-1]~ Finance[3:216,"MSCI"][-length(Finance[3:216,"MSCI"])]))
#bptest(lm(Finance[3:216,"OFR"][-1]~ Finance[3:216,"OFR"][-length(Finance[3:216,"OFR"])]))
#bptest(lm(Finance[,"Geo_i"][-1]~ Finance[,"Geo_i"][-length(Finance[,"Geo_i"])]))
#bptest(lm(Finance[,"Oil_p"][-1]~ Finance[,"Oil_p"][-length(Finance[,"Oil_p"])]))
#bptest(lm(Finance[,"EPU"][-1]~ Finance[,"EPU"][-length(Finance[,"EPU"])]))
#bptest(lm(Climate[,"Carbon_p"][-1]~ Climate[,"Carbon_p"][-length(Climate[,"Carbon_p"])]))
#bptest(lm(Climate[,"Tech"][-1]~ Climate[,"Tech"][-length(Climate[,"Tech"])]))
#bptest(lm(Climate[,"Natural"][-1]~ Climate[,"Natural"][-length(Climate[,"Natural"])]))
#bptest(lm(Climate[,"Green_e"][-1]~ Climate[,"Green_e"][-length(Climate[,"Green_e"])]))
#bptest(lm(Climate[,"Warming"][-1]~ Climate[,"Warming"][-length(Climate[,"Warming"])]))
#bptest(lm(Climate[,"Energy_i"][-1]~ Climate[,"Energy_i"][-length(Climate[,"Energy_i"])]))
#bptest(lm(Climate[,"Energy_s"][-1]~ Climate[,"Energy_s"][-length(Climate[,"Energy_s"])]))
#bptest(lm(Climate[3:216,"Tax"][-1]~ Climate[3:216,"Tax"][-length(Climate[3:216,"Tax"])]))

#bptest(lm(Climate[,"Energy_i"] ~ seq_along(Climate[,"Energy_i"])))
#bptest(lm(Climate[,"Energy_s"] ~ seq_along(Climate[,"Energy_s"])))
#bptest(lm(Climate[,"Warming"] ~ seq_along(Climate[,"Warming"])))
#bptest(lm(Climate[,"Natural"] ~ seq_along(Climate[,"Natural"])))
#bptest(lm(Climate[,"Green_e"] ~ seq_along(Climate[,"Green_e"])))
#bptest(lm(Climate[,"Tech"] ~ seq_along(Climate[,"Tech"])))
#bptest(lm(Climate[,"Carbon_p"] ~ seq_along(Climate[,"Carbon_p"])))
#bptest(lm(Finance[,"MSCI"] ~ seq_along(Finance[,"MSCI"])))
#bptest(lm(Finance[,"EPU"] ~ seq_along(Finance[,"EPU"])))
bptest(lm(Finance[,"OFR"] ~ seq_along(Finance[,"OFR"])))
#bptest(lm(Finance[,"Renixx"] ~ seq_along(Finance[,"Renixx"])))
#bptest(lm(Finance[,"Geo_i"] ~ seq_along(Finance[,"Geo_i"])))
#bptest(lm(Finance[,"Oil_p"] ~ seq_along(Finance[,"Oil_p"])))
#
#
#McLeod.Li.test(y=Climate[,"Energy_i"])
#McLeod.Li.test(y=Climate[,"Energy_s"])
#McLeod.Li.test(y=Climate[,"Natural"])
#McLeod.Li.test(y=Climate[,"Warming"])
#McLeod.Li.test(y=Climate[,"Carbon_p"])
#McLeod.Li.test(y=Climate[,"Green_e"])
#McLeod.Li.test(y=Climate[,"Tech"])
#McLeod.Li.test(y=Climate[,"Tax"])
#
#McLeod.Li.test(y=Finance[,"EPU"])
#McLeod.Li.test(y=Finance[,"OFR"])
#McLeod.Li.test(y=Finance[,"Geo_i"])
#McLeod.Li.test(y=Finance[,"MSCI"])
#McLeod.Li.test(y=Finance[,"Renixx"])
#McLeod.Li.test(y=Finance[,"Oil_p"])
```

```{r}
corrplot(cor(Climate[c(1:216),c(2:8)],method='kendall'), hclust.method='ward.D2',addrect=3,rect.col = 'gold',rect.lwd=4,order='hclust',diag=FALSE, method='square',bg='black',col=c('lightblue','green'),tl.col='black')
corrplot(cor(Finance[c(1:216),(2:length(Finance[1,]))],method='kendall'), hclust.method='ward.D2',addrect=3,rect.col = 'gold',rect.lwd=4,order='hclust',diag=FALSE, method='square',bg='black',col=c('lightblue','green'),tl.col='black')
```

```{r}
Finance$Merge<-format(as.Date(Finance$Month), "%Y-%m")
Climate$Merge<-format(as.Date(Climate$Date), "%Y-%m")

Data<-merge(Finance,Climate,by="Merge")
Data<- Data[c(2:216),-c(1,9)]
rownames(Data) <- NULL

corrplot(cor(Data[1:133,c(2:length(Data[1,]))],method='kendall'),diag=FALSE, method='square',bg='black',col=c('lightblue','green'),tl.col='black')
corrplot(cor(Data[134:177,c(2:length(Data[1,]))],method='kendall'),diag=FALSE, method='square',bg='black',col=c('lightblue','green'),tl.col='black')
corrplot(cor(Data[178:215,c(2:length(Data[1,]))],method='kendall'),diag=FALSE, method='square',bg='black',col=c('lightblue','green'),tl.col='black')
corrplot(cor(Data[,c(2:length(Data[1,]))],method='kendall'),diag=FALSE, method='square',bg='black',col=c('lightblue','green'),tl.col='black')
#"2016-03-01" "2019-10-01"
```

```{r}
Climate_2<-Climate_2[c('Date','Green_e','Tech','Warming','Natural','Carbon_p','Energy_i','Energy_s','Tax')]
Finance_2$Merge<-format(as.Date(Finance_2$Month), "%Y-%m")
Climate_2$Merge<-format(as.Date(Climate_2$Date), "%Y-%m")

Data_or<-merge(Finance_2,Climate_2,by="Merge")
Data_or<- Data_or[,-c(1,9)]
rownames(Data_or) <- NULL
```

#Cluster analysis

```{r}
library(dtw)
ratesa<-Data_or[1:134,]
ratesa$Month<-NULL;
ratesa<-ratesa
tr<-t(ratesa);
distMatrix <- dist(tr, method='DTW');
# hierarchical clustering
hc <- hclust(distMatrix,method="average")
plot(hc, main="Clustering by average")

ratesa<-Data_or[135:178,]
ratesa$Month<-NULL;
ratesa<-ratesa
tr<-t(ratesa);
distMatrix <- dist(tr, method='DTW');
# hierarchical clustering
hc <- hclust(distMatrix,method="average")
plot(hc, main="Clustering by average")

ratesa<-Data_or[179:216,]
ratesa$Month<-NULL;
ratesa<-ratesa
tr<-t(ratesa);
distMatrix <- dist(tr, method='DTW');
# hierarchical clustering
hc <- hclust(distMatrix,method="average")
plot(hc, main="Clustering by average")


ratesa<-Data_or[,]
ratesa$Month<-NULL;
ratesa<-ratesa
tr<-t(ratesa);
distMatrix <- dist(tr, method='DTW');
# hierarchical clustering
hc <- hclust(distMatrix,method="average")
plot(hc, main="Clustering by average")
```

#Factor analysis

```{r}
#https://rpubs.com/Pun_/Exploratory_factor_Analysis
#Promax Rotation. An oblique rotation, which allows factors to be correlated. This rotation can be calculated more quickly than a direct oblimin rotation, so it is useful for large datasets.
library(parameters)
library(psych)

Data_FA<-renixx_m[,c(1,4)]
colnames(Data_FA)[2] <- "Renixx"
Data_FA$Renixxlag<-lag(Finance$Renixx)
Data_FA$Oil_lagp<-lag(Finance$Oil_p)
Data_FA$MSCIlag<-lag(Finance$MSCI)
Data_FA$EPUlag<-lag(Finance$EPU)
Data_FA$Geo_lagi<-lag(Finance$Geo_i)
Data_FA$OFRlag<-lag(Finance$OFR)

Data_FA$Warminglag<-lag(global_w[,4])
Data_FA$Naturallag<-lag(Natural[,4])
Data_FA$Carbon_plag<-lag(Carbon_p[,4])
Data_FA$Techlag<-lag(Tech_d[,4])
Data_FA$Energy_ilag<-lag(Energy_i[,4])
Data_FA$Green_elag<-lag(green_e[,4])
Data_FA$Taxlag<-lag(Tax[,4])
Data_FA$Energy_slag<-lag(Energy_s[,4])

Data_FA<-Data_FA[c(2:216),]
rownames(Data_FA)<-NULL

KMO(Data_FA[,c(3:length(Data_FA[1,]))])
Data_factor <-Data_FA[,c(3:length(Data_FA[1,]))]
Data_factor <-Data_factor[,KMO(Data_factor)$MSAi>0.7]
base::round(KMO(Data_factor)$MSA,2)

cortest.bartlett(Data_factor)

ev <- eigen(cor(Data_factor)) # get eigenvalues
ev$values

scree(Data_factor, pc=FALSE)

fa.parallel(Data_factor)

Nfacs <- 2 # This is for four factors. You can change this as needed.

fit <- fa(Data_factor, Nfacs, rotate = "none",fm="promax")

print(fit, digits=3, cutoff=0.3, sort=TRUE)

loads <- fit$loadings

fa.diagram(loads)

dim(fit$loadings)

fs <- factor.scores(Data_factor, fit)   
fs <- fs$scores
Data_FA$Factor_climate<-fs[,1]
Data_FA$Factor_finance<-fs[,2]

Data_FA$OFR<-Fs_m$Rate[2:216]
cor(Data_FA$Factor_climate[c(1:133)],Data_FA$OFR[c(1:133)],method='kendal')
cor(Data_FA$Factor_climate[c(134:177)],Data_FA$OFR[c(134:177)],method='kendal')
cor(Data_FA$Factor_climate[c(178:215)],Data_FA$OFR[c(178:215)],method='kendal')

cor(Data_FA$Factor_finance[c(1:133)],Data_FA$OFR[c(1:133)],method='kendal')
cor(Data_FA$Factor_finance[c(134:177)],Data_FA$OFR[c(134:177)],method='kendal')
cor(Data_FA$Factor_finance[c(178:215)],Data_FA$OFR[c(178:215)],method='kendal')

var_fact<-VAR(Data_FA[c(1:215),c('OFRlag','Factor_climate')],season = 12,p=1,type='const')
summary(var_fact)
set.seed(6)
causality(var_fact, cause = 'Factor_climate', boot=TRUE, boot.runs=1000)
causality(var_fact, cause = 'OFRlag', boot=TRUE, boot.runs=1000)
```

#PCA Bubble

```{r}
library(xgboost)
library(caret)
library(Rssa)
library(lattice)
library(fANCOVA)
library(stats)
library(HoRM)
library(WaveletComp)
```

```{r}
#Standardize data before PCA

Data_PCA<-Data_FA[c(1:133),c(3:16)]
data_PCA<-prcomp(Data_PCA,scale =TRUE,center = TRUE)

autoplot(data_PCA,loadings=TRUE,loadings.colour='Blue',loadings.label=TRUE,loadings.labal.size=3,data=Data_FA[c(1:133),],colour='Renixx')

stats<-summary(data_PCA)
importance<-stats$importance[3,]
importance[importance<=0.85]

fviz_contrib(data_PCA, choice = "var", axes = 1, top = 3)
fviz_contrib(data_PCA, choice = "var", axes = 2, top = 3)
fviz_contrib(data_PCA, choice = "var", axes = 4, top = 3)

x_results<-as.data.frame(data_PCA$x)
PCA_data<-as.data.frame(x_results$PC1)
names(PCA_data)[1]<-'PC1'
PCA_data$PC2<-x_results$PC2
PCA_data$PC3<-x_results$PC3
PCA_data$PC4<-x_results$PC4
PCA_data$PC6<-x_results$PC6
PCA_data$PC7<-x_results$PC7

cor<-matrix(ncol=1,nrow=length(PCA_data[,]))
for(i in 1:length(PCA_data[,])){
  cor[i]<-cor(Data_FA$Renixx[1:133],(PCA_data[,i]),method='kendal')
}

plot(abs(cor))
```

```{r}
library(factoextra)
library(ggfortify)

Data_PCA<-Data_FA[c(134:177),c(3:16)]
data_PCA<-prcomp(Data_PCA,scale =TRUE,CENTER=TRUE)

autoplot(data_PCA,loadings=TRUE,loadings.colour='Blue',loadings.label=TRUE,loadings.labal.size=3,data=Data_FA[c(134:177),],colour='Renixx')

stats<-summary(data_PCA)
importance<-stats$importance[3,]
importance[importance<=0.85]

fviz_contrib(data_PCA, choice = "var", axes = 1, top = 3)
fviz_contrib(data_PCA, choice = "var", axes = 2, top = 3)
fviz_contrib(data_PCA, choice = "var", axes = 4, top = 3)

x_results<-as.data.frame(data_PCA$x)
PCA_data<-as.data.frame(x_results$PC1)
names(PCA_data)[1]<-'PC1'
PCA_data$PC2<-x_results$PC2
PCA_data$PC3<-x_results$PC3
PCA_data$PC4<-x_results$PC4
PCA_data$PC6<-x_results$PC6

cor<-matrix(ncol=1,nrow=length(PCA_data[,]))
for(i in 1:length(PCA_data[,])){
  cor[i]<-cor(Data_FA$Renixx[134:177],(PCA_data[,i]),method='kendal')
}

plot(abs(cor))
```

```{r}
Data_PCA<-Data_FA[c(178:215),c(3:16)]
data_PCA<-prcomp(Data_PCA,scale =TRUE,center=TRUE)

autoplot(data_PCA,loadings=TRUE,loadings.colour='Blue',loadings.label=TRUE,loadings.labal.size=3,data=Data_FA[c(178:215),],colour='Renixx')

stats<-summary(data_PCA)
importance<-stats$importance[3,]
importance[importance<=0.85]

fviz_contrib(data_PCA, choice = "var", axes = 1, top = 3)
fviz_contrib(data_PCA, choice = "var", axes = 2, top = 3)
fviz_contrib(data_PCA, choice = "var", axes = 4, top = 3)

x_results<-as.data.frame(data_PCA$x)
PCA_data<-as.data.frame(x_results$PC1)
names(PCA_data)[1]<-'PC1'
PCA_data$PC2<-x_results$PC2
PCA_data$PC3<-x_results$PC3
PCA_data$PC4<-x_results$PC4
PCA_data$PC6<-x_results$PC6

cor<-matrix(ncol=1,nrow=length(PCA_data[,]))
for(i in 1:length(PCA_data[,])){
  cor[i]<-cor(Data_FA$Renixx[178:215],(PCA_data[,i]),method='kendal')
}

plot(abs(cor))
```

# PCA explosion

```{r}
Data_FA$dummy <- as.factor(ifelse(Data_FA$Month >= "2007-07-01" & Data_FA$Month <= "2007-08-01"|Data_FA$Month >= "2007-10-01" & Data_FA$Month <= "2008-01-01"|Data_FA$Month >= "2015-04-01" & Data_FA$Month <= "2015-06-01"|Data_FA$Month >= "2019-12-01" & Data_FA$Month <= "2020-03-01"|Data_FA$Month >= "2020-07-01" & Data_FA$Month <= "2021-05-01"|Data_FA$Month >= "2021-11-01" & Data_FA$Month <= "2021-12-01", 1,0))

Data_exp<-Data_FA[Data_FA$dummy==1,c(4:length(Data_FA)-2)]
Data_noexp<-Data_FA[Data_FA$dummy==0,c(4:length(Data_FA)-2)]
```

#Explosive/no explosive

```{r}
d_adf
data_PCA<-prcomp(Data_exp[,c(4:length(Data_exp)-2)],scale =TRUE)

autoplot(data_PCA,loadings=TRUE,loadings.colour='Blue',loadings.label=TRUE,loadings.labal.size=3,data=Data_exp,colour='Renixx')

stats<-summary(data_PCA)
importance<-stats$importance[3,]
importance[importance<=0.85]

fviz_contrib(data_PCA, choice = "var", axes = 1, top = 3)
fviz_contrib(data_PCA, choice = "var", axes = 2, top = 3)

x_results<-as.data.frame(data_PCA$x)
PCA_data<-as.data.frame(x_results$PC1)
names(PCA_data)[1]<-'PC1'
PCA_data$PC2<-x_results$PC2
PCA_data$PC3<-x_results$PC3
PCA_data$PC4<-x_results$PC4
PCA_data$PC5<-x_results$PC5

cor<-matrix(ncol=1,nrow=length(PCA_data[,]))
for(i in 1:length(PCA_data[,])){
  cor[i]<-cor(Data_exp$Renixx,(PCA_data[,i]),method='kendal')
}

plot(abs(cor))

corrplot(cor(Data_exp[,c(3:length(Data_exp)-2)],method='kendall'),diag=FALSE, method='square',bg='black',col=c('lightblue','green'),tl.col='black')

corrplot(cor(Data_noexp[,c(3:length(Data_noexp)-2)],method='kendall'),diag=FALSE, method='square',bg='black',col=c('lightblue','green'),tl.col='black')


ratesa<-Data_or[Data_FA$dummy==1,]
ratesa$Month<-NULL;
ratesa<-ratesa
tr<-t(ratesa);
distMatrix <- dist(tr, method='DTW');
# hierarchical clustering
hc <- hclust(distMatrix,method="average")
plot(hc, main="Clustering by average")


ratesa<-Data_or[Data_FA$dummy==0,]
ratesa$Month<-NULL;
ratesa<-ratesa
tr<-t(ratesa);
distMatrix <- dist(tr, method='DTW');
# hierarchical clustering
hc <- hclust(distMatrix,method="average")
plot(hc, main="Clustering by average")

cor(Data_exp$Factor_climate,Data_exp$Renixx,method='kendal')
cor(Data_exp$Factor_finance,Data_exp$Renixx,method='kendal')
cor(Data_exp$Factor_climate,Data_exp$OFRlag,method='kendal')
cor(Data_exp$Factor_finance,Data_exp$OFRlag,method='kendal')

tvLM<-tvLM(Renixx ~ 0 +Renixxlag+Energy_ilag+Energy_slag+Carbon_plag+Green_elag+Taxlag+MSCIlag+Warminglag+Naturallag+Techlag, data = Data_FA, bw = 0.5)
plot(tvLM$coefficients[,1])
```

#What drives bubbles in terms of text analysis.

#Descriptive Statistics

```{r}
#Dummy
Data_2<-renixx_m[c(2:216),c(1,4)]
colnames(Data_2)[2] <- "Renixx"

Data_2$dummy_Renixx  <- cut(Data_2$Month,
              breaks= as.Date(c("2005-01-01","2016-03-01","2019-11-01",'2023-01-01')),
              labels=c('Clean-tech', 'No-bubble', 'Green'))

Data_2$dummy_Renixx<-relevel(Data_2$dummy_Renixx, ref = 'No-bubble')

Data_2$Energy_ilag<-lag(Data_or$Energy_i)[2:216]
Data_2$Warminglag<-lag(Data_or$Warming)[2:216]
Data_2$Naturallag<-lag(Data_or$Natural)[2:216]
Data_2$Green_elag<-lag(Data_or$Green_e)[2:216]
Data_2$Carbon_plag<-lag(Data_or$Carbon_p)[2:216]
Data_2$Techlag<-lag(Data_or$Tech)[2:216]
Data_2$Energy_slag<-lag(Data_or$Energy_s)[2:216]
Data_2$Taxlag<-lag(Data_or$Tax)[2:216]

Data_2<-Data_2[,-c(1,2)]

rownames(Data_2) <- NULL

str(Data_2)
```

```{r}
library(grid)

p1 <- ggplot(Data_2, aes(x=Green_elag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx))+ labs(fill='Bubble')+
      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Green Energy')
p2 <- ggplot(Data_2, aes(x=Naturallag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4)+
      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Natural Disasters')+ labs(fill='Bubble') 
p3 <- ggplot(Data_2, aes(x=Carbon_plag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) + xlab('Carbon price')+
      guides(color = "none")+ geom_density(alpha=0.4) + labs(fill='Bubble') 
p4 <- ggplot(Data_2, aes(x=Energy_ilag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Energy Index')+ labs(fill='Bubble') 
p5 <- ggplot(Data_2, aes(x=Warminglag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Global Warming')+ labs(fill='Bubble')
p6 <- ggplot(Data_2, aes(x=Techlag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
      guides(color = "none")+ geom_density(alpha=0.4) + xlab('New Technology')+ labs(fill='Bubble')
p7 <- ggplot(Data_2, aes(x=Energy_slag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
     guides(color = "none")+ geom_density(alpha=0.4) + xlab('Energy Shares')+ labs(fill='Bubble')
p8 <- ggplot(Data_2, aes(x=Taxlag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
     guides(color = "none")+ geom_density(alpha=0.4) + xlab('Carbon Tax')+ labs(fill='Bubble')
grid.arrange(p1, p2, p3, p4, p5, p6,p7,p8, ncol=2,top = textGrob("Renixx Global Index Phases",gp=gpar(fontsize=20,font=3)))
```

```{r}
smp_size <- floor(0.7 * nrow(Data_2))
Data_multi<-Data_2
Data_multi$Time<-c(1:215)
## set the seed to make your partition reproducible
set.seed(1239)
train_ind <- sample(seq_len(nrow(Data_multi)), size = smp_size)

train.data <- Data_multi[train_ind, ]
vali.data <- Data_multi[-train_ind, ] 
# Dumy code categorical predictor variables
x <- model.matrix(dummy_Renixx ~., train.data)[,-1]
y<-train.data$dummy_Renixx
```

```{r}
# Find the best lambda using cross-validation
set.seed(123) 
cv.lasso <- cv.glmnet(x, y, alpha = 1, family = "multinomial")
# Fit the final model on the training data
model <- glmnet(x, y, alpha = 1, family = "multinomial",
                lambda = cv.lasso$lambda.min)
# Display regression coefficients
coef(model)
# Display regression coefficients
library(plotmo)
plot_glmnet(cv.lasso$glmnet.fit, label=TRUE,nresponse = 3)
plot_glmnet(cv.lasso$glmnet.fit, label=TRUE,nresponse = 2)
plot_glmnet(cv.lasso$glmnet.fit, label=TRUE,nresponse = 1)
```

```{r}
set.seed(123)
cv.lasso <- cv.glmnet(x, y, alpha = 1, family = "multinomial")
plot(cv.lasso)
```

```{r}
cv.lasso$lambda.min
coef(cv.lasso, cv.lasso$lambda.min)
```

```{r}
lasso.model <- glmnet(x, y, alpha = 1, family = "multinomial",
                      lambda = cv.lasso$lambda.min)
# Make prediction on test data
x.test <- model.matrix(dummy_Renixx ~., vali.data)[,-1]
probabilities <- lasso.model %>% predict(newx = x.test)
predicted.classes <- probabilities

for(i in 1:length(probabilities[,1,])){
  for(j in 1:length(probabilities[1,,])){
predicted.classes[i,j,] <- ifelse(probabilities[i,j,]==max(probabilities[i,,]), 1, 0)
}
}

predicted.classes

# 3 errors on 65
```

#Model logit explosive

```{r}
df <- renixx %>% dplyr::select(1,5)
Month<- as.Date(cut(df$date, "month"))
renixx_m$low <- aggregate(low ~ Month, df, mean)[13:228,2]

df <- renixx %>% dplyr::select(1,4)
Month<- as.Date(cut(df$date, "month"))
renixx_m$high <- aggregate(high ~ Month, df, mean)[13:228,2]
```

```{r}
#Data_2<-renixx_m[c(2:216),c(1,4)]
#colnames(Data_2)[2] <- "Renixx"

Data_2$dummy_Renixx<- as.factor(ifelse(Data_FA$Month >= "2007-07-01" & Data_FA$Month <= "2007-08-01"|Data_FA$Month >= "2007-10-01" & Data_FA$Month <= "2008-01-01"|Data_FA$Month >= "2015-04-01" & Data_FA$Month <= "2015-06-01"|Data_FA$Month >= "2019-12-01" & Data_FA$Month <= "2020-03-01"|Data_FA$Month >= "2020-07-01" & Data_FA$Month <= "2021-05-01"|Data_FA$Month >= "2021-11-01" & Data_FA$Month <= "2021-12-01", 'Explosive','No-Explosive'))
Data_2$dummy_Renixx
Data_2$dummy_Renixx<-relevel(Data_2$dummy_Renixx, ref = 'No-Explosive')

Data_2$diff_Enii<-lag((Data_or$Renixx-Data_or$Energy_i))[2:216]
Data_2$diff_Enis<-lag((Data_or$Renixx-Data_or$Energy_s))[2:216]
#Data_2$enfin<-lag(scale(Energy_stock$Absolute.Google.Search.Volume[13:228],center=TRUE,scale=TRUE))[2:216]
#Data_2$diff_Greene<-lag((Data_or$Tech-Data_or$Renixx))[2:216]
#Data_2$volume<-lag(renixx_m$high-renixx_m$low)[2:216]
#Data_2$diff_MSCI<-lag((Data_or$MSCI-Data_or$Renixx))[2:216]
Data_2$MSCIlag<-lag(Data_or$MSCI)[2:216]
Data_2$Oillag<-lag(Data_or$Oil_p)[2:216]
Data_2$EPUlag<-lag(Data_or$EPU)[2:216]
Data_2$OFRlag<-lag(Data_or$OFR)[2:216]
#Data_2$Renixxlag<-lag(Data_or$Renixx)[2:216]


#Data_2$MSCIlag<-c(0,abs(diff(Data_2$MSCIlag)))
#Data_2$Oillag<-c(0,abs(diff(Data_2$Oillag)))
#Data_2$EPUlag<-c(0,abs(diff(Data_2$EPUlag)))
#Data_2$OFRlag<-c(0,abs(diff(Data_2$OFRlag)))
#Data_2$Renixxlag<-c(0,abs(diff(Data_2$Renixxlag)))
#Data_2$Energy_ilag<-c(0,abs(diff(Data_2$Energy_ilag)))
#Data_2$Energy_slag<-c(0,abs(diff(Data_2$Energy_slag)))
#Data_2$Warminglag<-c(0,abs(diff(Data_2$Warminglag)))
#Data_2$Naturallag<-c(0,abs(diff(Data_2$Naturallag)))
#Data_2$Techlag<-c(0,abs(diff(Data_2$Techlag)))
#Data_2$Taxlag<-c(0,abs(diff(Data_2$Taxlag)))
#Data_2$Green_elag<-c(0,abs(diff(Data_2$Green_elag)))
#Data_2$Carbon_plag<-c(0,abs(diff(Data_2$Carbon_plag)))
#Data_2$Renixxlag<-lag(Data_or$Renixx)[2:216]

#library(tvReg)
##tvar<-tvAR(as.vector(Data_2$MSCIlag), p = 1)
##Data_2$coef_MSCI<-c(0,abs(tvar$residuals))
#tvar<-tvAR(as.vector(Data$Renixx), p = 1)
#Data_2$coef_Renixx<-c(0,abs(tvar$residuals))
#tvar<-tvAR(as.vector(Data_2$EPUlag), p = 1)
#Data_2$coef_EPU<-c(0,tvar$coefficients[,2])
#tvar<-tvAR(as.vector(Data_2$Energy_slag), p = 1)
#Data_2$coef_Energy_s<-c(0,tvar$coefficients[,2])
#
#tv_var<-tvVAR(Data[,c('Renixx','Carbon_p')])
#plot(tv_var)
#Data_2$coef_enivar<-c(0,tv_var$coefficients$Energy_slag[,1])

Data_2$Oillag<-c(0,diff(Data_2$Oillag))
Data_2$EPUlag<-c(0,diff(Data_2$EPUlag))
Data_2$MSCIlag<-c(0,diff(Data_2$MSCIlag))
Data_2$OFRlag<-c(0,diff(Data_2$OFRlag))
#
#Data_2$Energy_ilag<-c(0,diff(Data_2$Energy_ilag))
#Data_2$Energy_slag<-c(0,diff(Data_2$Energy_slag))
#Data_2$Warminglag<-c(0,diff(Data_2$Warminglag))
#Data_2$Naturallag<-c(0,diff(Data_2$Naturallag))
#Data_2$Techlag<-c(0,diff(Data_2$Techlag))
#Data_2$Taxlag<-c(0,diff(Data_2$Taxlag))
#Data_2$Green_elag<-c(0,diff(Data_2$Green_elag))
#Data_2$Carbon_plag<-c(0,diff(Data_2$Carbon_plag))

#Data_2<-Data_2[,-c(1,2)]

#rownames(Data_2) <- NULL

#str(Data_2)
```

```{r}
p1 <- ggplot(Data_2, aes(x=Green_elag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx))+ labs(fill='Green bubble')+
      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Green Energy')
p2 <- ggplot(Data_2, aes(x=Naturallag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4)+
      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Natural disaster')+ labs(fill='Green bubble') 
p3 <- ggplot(Data_2, aes(x=Carbon_plag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) + xlab('Carbon price')+
      guides(color = "none")+ geom_density(alpha=0.4) + labs(fill='Green bubble') 
p4 <- ggplot(Data_2, aes(x=Energy_ilag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Energy Index')+ labs(fill='Green bubble') 
p5 <- ggplot(Data_2, aes(x=Warminglag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Global Warming')+ labs(fill='Green bubble')
p6 <- ggplot(Data_2, aes(x=Techlag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
      guides(color = "none")+ geom_density(alpha=0.4) + xlab('New Technology')+ labs(fill='Green bubble')
p7 <- ggplot(Data_2, aes(x=Energy_slag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
     guides(color = "none")+ geom_density(alpha=0.4) + xlab('Energy Shares')+ labs(fill='Green bubble')
p8 <- ggplot(Data_2, aes(x=Taxlag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
     guides(color = "none")+ geom_density(alpha=0.4) + xlab('Carbon Tax')+ labs(fill='Green bubble')
grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, ncol=2,top = textGrob("Renixx Global Index Explosive Evets",gp=gpar(fontsize=20,font=3)))
```

```{r}
p9 <- ggplot(Data_2, aes(x=OFRlag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
      guides(color = "none")+ geom_density(alpha=0.4) + xlab('OFR')+ labs(fill='Green bubble')
p10 <- ggplot(Data_2, aes(x=MSCIlag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
      guides(color = "none")+ geom_density(alpha=0.4) + xlab('MSCI')+ labs(fill='Green bubble')
p11 <- ggplot(Data_2, aes(x=EPUlag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
     guides(color = "none")+ geom_density(alpha=0.4) + xlab('EPU')+ labs(fill='Green bubble')
p12 <- ggplot(Data_2, aes(x=Oillag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
     guides(color = "none")+ geom_density(alpha=0.4) + xlab('Oil price')+ labs(fill='Green bubble')

p13 <- ggplot(Data_2, aes(x=diff_Enii, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
     guides(color = "none")+ geom_density(alpha=0.4) + xlab('Dfference Energy Index')+ labs(fill='Green bubble')

p14 <- ggplot(Data_2, aes(x=diff_Enis, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
     guides(color = "none")+ geom_density(alpha=0.4) + xlab('Dfference Energy Shares')+ labs(fill='Green bubble')

grid.arrange(p9, p10, p11, p12,p13,p14, ncol=2,top = textGrob("Renixx Global Index Explosive Evets",gp=gpar(fontsize=20,font=3)))
```

#Time-logit-Lasso

```{r}
library(caret)
Data_2$dummy_Renixx<- as.factor(ifelse(Data_FA$Month >= "2007-07-01" & Data_FA$Month <= "2007-08-01"|Data_FA$Month >= "2007-10-01" & Data_FA$Month <= "2008-01-01"|Data_FA$Month >= "2015-04-01" & Data_FA$Month <= "2015-06-01"|Data_FA$Month >= "2019-12-01" & Data_FA$Month <= "2020-03-01"|Data_FA$Month >= "2020-07-01" & Data_FA$Month <= "2021-05-01"|Data_FA$Month >= "2021-11-01" & Data_FA$Month <= "2021-12-01", 1,0))
#Data_2$Carbon_plag<-as.factor(ifelse(Data_2$Carbon_plag>1, 1,0))
#Data_2$Energy_slag<-as.factor(ifelse(Data_2$Energy_slag>1, 1,0))
#Data_2$MSCIlag<-as.factor(ifelse(Data_2$MSCIlag>1, 1,0))

train.data  <- Data_2[c(1:190),]
vali.data <- Data_2[c(191:215),]
train.data$Time<-c(1:190) 
vali.data$Time<-c(191:215)
# Dumy code categorical predictor variables
x <- model.matrix(dummy_Renixx ~., train.data)[,-1]
# Convert the outcome (class) to a numerical variable
y <- train.data$dummy_Renixx
```

```{r}
set.seed(123)
seeds <- vector(mode = "list", length = 65)
for(i in 1:64) seeds[[i]] <- sample.int(1000, 15)
seeds[[65]] <- sample.int(1000, 1)
tuneLength.num <- 15
myTimeControl <- trainControl(method = "timeslice",
                              initialWindow = 130,
                              horizon = 30,
                              fixedWindow = FALSE,
                              allowParallel = TRUE,
                              seeds = seeds)

glmnet.mod <- train(dummy_Renixx ~.,
                    data = train.data,
                    method = "glmnet",
                    family = "binomial",
                    trControl = c(myTimeControl),
                    tuneLength=tuneLength.num) 
glmnet.mod
```

```{r}
# Fit the final model on the training data
model <- glmnet(x, y, alpha = glmnet.mod$bestTune$alpha, family = "binomial",
                lambda =glmnet.mod$bestTune$lambda)
model_plot <- glmnet(x, y, alpha = glmnet.mod$bestTune$alpha, family = "binomial")
# Display regression coefficients
coef(model)
# Make predictions on the test data
x.test <- model.matrix(dummy_Renixx ~., vali.data)[,-1]
probabilities <- model %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, 1, 0)
# Model accuracy
observed.classes <- vali.data$dummy_Renixx
mean(predicted.classes == observed.classes)
confusionMatrix(as.factor(predicted.classes[,1]), observed.classes)

plot(model_plot, xvar = "lambda", label=T)
#lbs_fun(model)

lbs_fun <- function(fit, offset_x=1, ...) {
L <- length(fit$lambda)
x <- log(fit$lambda[L])+ offset_x
y <- fit$beta[, L]
labs <- names(y)
text(x, y, labels=labs, ...)
}
```

#XGBoost

```{r}
#tunning parameters
train.data  <- Data_2[c(1:184), ] #1:774
test.data <- Data_2[c(185:190), ] #775:834
val.data <- Data_2[c(191:215), ] #834:934
all.data<-Data_2[c(1:190), ]

label = as.numeric(Data_2$dummy_Renixx)-1
train.label = label[c(1:184)]
test.label = label[c(185:190)]
val.label = label[c(191:215)]
all.label = label[c(1:190)]

train = data.matrix(train.data[,-1])
test = data.matrix(test.data[,-1])
val = data.matrix(val.data[,-1])
all = data.matrix(all.data[,-1])

xgb_train = xgb.DMatrix(data = train, label=train.label)
xgb_test = xgb.DMatrix(data = test, label=test.label)
xgb_val = xgb.DMatrix(data = val, label=val.label)
xgb_all = xgb.DMatrix(data = all, label=all.label)

watchlist = list(train=xgb_train, test=xgb_test)
```

```{r}
#create hyperparameter grid
max.depths = seq(1,10,by=1)
etas = seq(0.1,8,by=0.1)
alpha = seq(0.1,1,by=0.1)
lambda = seq(0.1,1,by=0.1)

best_params = 0
best_score = 0
best_it = 0

count = 1
for(depth in max.depths ){
    for(num in etas){
      for(a in alpha){
        for(l in lambda){

        bst_grid = xgb.train(data = xgb_train, 
                                max.depth = depth, 
                                eta=num, 
                                nthread = 2, 
                                nround = 1000, 
                                watchlist = watchlist, 
                                #objective = "reg:squarederror", 
                                early_stopping_rounds = 50, 
                                verbose=0,
                                booster="gbtree",
                                objective="multi:softprob",
                                eval_metric="mlogloss",
                                num_class=2,
                                alpha=a,
                                lambda=l
                                )

        if(count == 1){
            best_params = bst_grid$params
            best_score = bst_grid$best_score
            best_it= bst_grid$best_iteration
            count = count + 1
            }
        else if(bst_grid$best_score < best_score){
            best_params = bst_grid$params
            best_score = bst_grid$best_score
            best_it= bst_grid$best_iteration
        }
    }
}
    }
}

best_params
best_score
best_it
```

```{r}
model_xgb = xgb.train(data = xgb_all, nthread = 2, eta = best_params$eta, max.depth = best_params$max_depth,verbose = 1,booster="gbtree", objective="multi:softprob",eval_metric="mlogloss", num_class=2,nrounds=best_it, alpah=best_params$alpha,lambda=best_params$lambda)

summary(model_xgb)

test_pred = predict(model_xgb, xgb_val)
test_prediction <- matrix(test_pred, nrow = 2,
                          ncol=length(test_pred)/2) %>%
  t() %>%
  data.frame() %>%
  mutate(label = val.label + 1,
         max_prob = max.col(., "last"))

test_prediction$max_prob
test_prediction$label
```

```{r}
importance <- xgb.importance(feature_names = colnames(xgb_test),model = model_xgb)
print(xgb.ggplot.importance(importance_matrix = importance))
```

#Logit model

```{r}
model_f<-glm(dummy_Renixx ~., family = binomial(link = "logit"), data = Data_2)
model_0<-glm(dummy_Renixx ~1, family = binomial(link = "logit"), data = Data_2)
model_2<-glm(dummy_Renixx ~Energy_slag+MSCIlag+diff_Enii, family = binomial(link = "logit"), data = Data_2)
summary(model_2)
model_2$deviance
-2*logLik(model_2)

vif(model_2)
lrtest (model_0, model_2)
lrtest (model_2, model_f)
blr_linktest(model_2)

y_hat2 <- predict(model_2, type='response')
mean((y_hat2 >= 0.5 & Data_2[,]$dummy_Renixx==0) | (y_hat2 < 0.5 & Data_2[,]$dummy_Renixx==1))
1 - max(prop.table(table(Data_2[,]$dummy_Renixx)))

list(model = pscl::pR2(model_2)["McFadden"])

model1_data <- augment(model_2) %>% mutate(index = 1:n())

ggplot(model1_data, aes(index, .std.resid, color = dummy_Renixx)) + 
  geom_point(alpha = .5) +
  geom_ref_line(h = 3)

exp(coef(model_2))
logistic.display(model_2)
or_glm(data = Data_2, model = model_2, incr = c(Naturallag=0.1,Green_elag=0.1,Energy_ilag=0.1,Techlag=0.1,Carbon_plag=0.1,Warminglag=0.1,Energy_slag=0.1,Taxlag=0.1,MSCIlag=0.1,diff_Enii=0.1))
```

#VAR

```{r}
#granger causality
library(lmtest)
Finance$Merge<-format(as.Date(Finance$Month), "%Y-%m")
Climate$Merge<-format(as.Date(Climate$Date), "%Y-%m")

Data_3<-merge(Finance,Climate,by="Merge")
Data_3<- Data_3[c(1:216),-c(1,9)]
#bj<-boxcox(Energy_s$Absolute.Google.Search.Volume+Energy_i$Absolute.Google.Search.Volume)
Data_3$Energy_n<-c(0,diff(log(Energy_s$Absolute.Google.Search.Volume+Energy_i$Absolute.Google.Search.Volume)))
rownames(Data_3) <- NULL

grangertest(MSCI ~ Renixx, order =12, data = Data_3)
grangertest(MSCI ~ Oil_p, order =12, data = Data_3)#Granger
grangertest(MSCI ~ Geo_i, order =12, data = Data_3)
grangertest(MSCI ~ Energy_i, order =12, data = Data_3)
grangertest(MSCI ~ Green_e, order =12, data = Data_3)
grangertest(MSCI ~ Tech, order =12, data = Data_3)
grangertest(MSCI ~ Warming, order =12, data = Data_3)
grangertest(MSCI ~ Natural, order =12, data = Data_3)
grangertest(MSCI ~ Carbon_p, order =12, data = Data_3)
grangertest(MSCI ~ Tax, order =12, data = Data_3)
grangertest(MSCI ~ Energy_s, order =12, data = Data_3)
grangertest(MSCI ~ EPU, order =12, data = Data_3)
grangertest(MSCI ~ OFR, order =12, data = Data_3)

grangertest(Renixx ~ MSCI, order = 12, data = Data_3)
grangertest(Renixx ~ Oil_p, order = 12, data = Data_3)#Granger
grangertest(Renixx ~ Geo_i, order = 12, data = Data_3)
grangertest(Renixx ~ Energy_i, order = 12, data = Data_3)
grangertest(Renixx ~ Green_e, order = 12, data = Data_3)
grangertest(Renixx ~ Tech, order = 12, data = Data_3)
grangertest(Renixx ~ Warming, order = 12, data = Data_3)
grangertest(Renixx ~ Natural, order = 12, data = Data_3)
grangertest(Renixx ~ Carbon_p, order = 12, data = Data_3)
grangertest(Renixx ~ EPU, order = 12, data = Data_3)#Granger
grangertest(Renixx ~ OFR, order = 12, data = Data_3)
grangertest(Renixx ~ Energy_s, order = 12, data = Data_3)
grangertest(Renixx ~ Energy_n, order = 12, data = Data_3)

grangertest(Energy_i ~ MSCI, order = 12, data = Data_3)
grangertest(Energy_i ~ Oil_p, order = 12, data = Data_3)
grangertest(Energy_i ~ Geo_i, order = 12, data = Data_3)
grangertest(Energy_i ~ Renixx, order = 12, data = Data_3)
grangertest(Energy_i ~ Green_e, order = 12, data = Data_3)#Granger
grangertest(Energy_i ~ Tech, order = 12, data = Data_3)#Granger
grangertest(Energy_i ~ Warming, order = 12, data = Data_3)#Granger
grangertest(Energy_i ~ Natural, order = 12, data = Data_3)#Granger
grangertest(Energy_i ~ Carbon_p, order = 12, data = Data_3)
grangertest(Energy_i ~ EPU, order = 12, data = Data_3)
grangertest(Energy_i ~ OFR, order = 12, data = Data_3)

grangertest(Oil_p ~ MSCI, order = 12, data = Data_3)#Granger
grangertest(Oil_p ~ Natural, order = 12, data = Data_3)
grangertest(Oil_p ~ Geo_i, order = 12, data = Data_3)
grangertest(Oil_p ~ Renixx, order = 12, data = Data_3)
grangertest(Oil_p ~ Green_e, order = 12, data = Data_3)
grangertest(Oil_p ~ Tech, order = 12, data = Data_3)
grangertest(Oil_p ~ Warming, order = 12, data = Data_3)
grangertest(Oil_p ~ Energy_i, order = 12, data = Data_3)
grangertest(Oil_p ~ Carbon_p, order = 12, data = Data_3)
grangertest(Oil_p ~ EPU, order = 12, data = Data_3)
grangertest(Oil_p ~ OFR, order = 12, data = Data_3)#Granger

grangertest(OFR ~ MSCI, order = 12, data = Data_3)#Granger
grangertest(OFR ~ Oil_p, order = 12, data = Data_3)#Granger
grangertest(OFR ~ Geo_i, order = 12, data = Data_3)
grangertest(OFR ~ Renixx, order = 12, data = Data_3)#Granger
grangertest(OFR ~ Green_e, order = 12, data = Data_3)
grangertest(OFR ~ Tech, order = 12, data = Data_3)
grangertest(OFR ~ Warming, order = 12, data = Data_3)
grangertest(OFR ~ Natural, order = 12, data = Data_3)
grangertest(OFR ~ Carbon_p, order = 12, data = Data_3)
grangertest(OFR ~ EPU, order = 12, data = Data_3)
grangertest(OFR ~ Energy_i, order = 12, data = Data_3)

grangertest(Renixx ~ Energy_i, order = 12, data = Data_3[121:216,])#Granger
grangertest(Renixx ~ Energy_s, order = 12, data = Data_3[121:216,])#Granger
grangertest(Renixx ~ Energy_n, order = 12, data = Data_3[121:216,])#Granger
#Granger
grangertest(Energy_s ~ Renixx, order = 12, data = Data_3[121:216,])
grangertest(Energy_i ~ Renixx, order = 12, data = Data_3[121:216,])
grangertest(Energy_n ~ Renixx, order = 12, data = Data_3[121:216,])#Granger

grangertest(Renixx ~ MSCI, order = 12, data = Data_3[121:216,])
#grangertest(Oil_p ~ Renixx, order = 12, data = Data_3[121:216,])
grangertest(Renixx ~ Oil_p, order = 12, data = Data_3[121:216,])#Granger
grangertest(Renixx ~ Geo_i, order = 12, data = Data_3[121:216,])
grangertest(Renixx ~ Energy_n, order = 12, data = Data_3[121:216,])#Granger
grangertest(Renixx ~ Green_e, order = 12, data = Data_3[121:216,])
grangertest(Renixx ~ Tech, order = 12, data = Data_3[121:216,])
grangertest(Renixx ~ Warming, order = 12, data = Data_3[121:216,])
grangertest(Renixx ~ Natural, order = 12, data = Data_3[121:216,])
grangertest(Renixx ~ Carbon_p, order = 12, data = Data_3[121:216,])
grangertest(Renixx ~ EPU, order = 12, data = Data_3[121:216,])
grangertest(Renixx ~ OFR, order = 12, data = Data_3[121:216,])
grangertest(Renixx ~ Energy_i, order = 12, data = Data_3[121:216,])#Granger
grangertest(Renixx ~ Energy_s, order = 12, data = Data_3[121:216,])#Granger
```

```{r}
#bc_obj<-boxcox(Energy_i$Absolute.Google.Search.Volume*0.5+Energy_s$Absolute.Google.Search.Volume*0.5)
Data_or$Energy_n<-scale(Energy_i$Absolute.Google.Search.Volume+Energy_s$Absolute.Google.Search.Volume,center=TRUE,scale=TRUE)
ggplot() + 
     geom_line(data = Data_or, aes(x = Month, y = Renixx, color = "Renixx")) +
     geom_line(data = Data_or, aes(x = Month, y = Energy_i, color = 'Energy Index'))+
  geom_line(data = Data_or, aes(x = Month, y = Energy_n, color = 'Energy New'))+
  xlab('Date') + ggtitle('Series')+
  ylab('Monthly series')+ scale_color_manual(name='Series',
                     breaks=c('Renixx', 'Energy Index', 'Energy New'),
                     values=c('Renixx'='red', 'Energy Index'='blue','Energy New'='darkgreen'))

cor(Data_or$Renixx,Data_or$Energy_i)
cor(Data_or$Energy_i[121:216],Data_or$Renixx[121:216])
cor(Data_or$Energy_s[121:216],Data_or$Renixx[121:216])
cor(Data_or$Oil_p[121:216],Data_or$Renixx[121:216])
```

```{r}
library(vars)

#Data_VECM<-as.data.frame(diff(renixx_m$close))
#colnames(Data_VECM)[1]<-'Renixx'
#Data_VECM$Oil_p<-diff(Oil_m$Price)
#Data_VECM$Energy_i<-diff(as.numeric(Energy_i[13:228,3]))
#Data_VECM$OFR<-Fs_m$OFR.FSI[2:216]

#Data_VECM$Energy_s<-log(Energy_s$Absolute.Google.Search.Volume[13:228]/2+Energy_s$Absolute.Goog#le.Search.Volume[13:228]/2)
#Data_VECM$Energy_s<-log(Energy_s$Absolute.Google.Search.Volume[13:228])
#Data_VECM$dummy_Renixx<- as.numeric(cut(Data_or$Month,
              #breaks= as.Date(c("2005-01-01","2016-03-01","2019-11-01",'2023-01-01')),
              #labels=c(1, 0, 1)))
#Data_VECM$dummy_OFR<- as.numeric(ifelse(Data_VECM$OFR >=0,1,0))
#Data_VECM$dummy_Renixx2<- as.numeric(ifelse(Data_or$Month >= "2007-07-01" & Data_or$Month <= #"2007-08-01"|Data_or$Month >= "2007-10-01" & Data_or$Month <= "2008-01-01"|Data_or$Month >= #"2015-04-01" & Data_or$Month <= "2015-06-01"|Data_or$Month >= "2019-12-01" & Data_or$Month <= #"2020-03-01"|Data_or$Month >= "2020-07-01" & Data_or$Month <= "2021-05-01"|Data_or$Month >= #"2021-11-01" & Data_FA$Month <= "2021-12-01", 1,0))

#corrplot(cor(Data_VECM,method='pearson'),diag=FALSE, method='square',bg='black',col=c('lightblue','green'),tl.col='black')
```

```{r}
#all_series<-read.zoo(Data_VECM[,c('Renixx','Energy_i')])
#all_series<-as.ts(Data_VECM[,c('Renixx','Energy_i','Oil_p')])
#
#var <- VARselect(all_series, type = "none", lag.max = 12, season = 12)
#var$selection["AIC(n)"] #no-passed test
##c('EPU','Geo_i','dummy_Renixx','dummy_Renixx2','Tech','Natural','OFR','Carbon_p','Warming','Gr#een_e')
#fitvar1 = VAR(all_series,9, season = 12, type = 'none') #8 to pass all tests
##summary(fitvar1)
#summary(fitvar1)
```

```{r}
library(bruceR)
#distBCMod<-BoxCoxTrans(renixx_m$close)
#bc_obj<-boxcox(renixx_m$close)
#Data_VECM<-as.data.frame(predict(bc_obj))
Data_VECM<-as.data.frame(log(renixx_m$close))
colnames(Data_VECM)[1]<-'Renixx'

#bc_obj<-boxcox(Energy_i$Absolute.Google.Search.Volume)
#Data_VECM$Energy_i<-predict(bc_obj)
Data_VECM$Energy_i<-log(Energy_i$Absolute.Google.Search.Volume)

#bc_obj<-boxcox(Energy_s$Absolute.Google.Search.Volume)
#Data_VECM$Energy_s<-predict(bc_obj)
Data_VECM$Energy_s<-log(Energy_s$Absolute.Google.Search.Volume)

#bc_obj<-boxcox(Energy_s$Absolute.Google.Search.Volume+Energy_i$Absolute.Google.Search.Volume)
#Data_VECM$Energy_n<-predict(bc_obj)
Data_VECM$Energy_n<-log(Energy_s$Absolute.Google.Search.Volume+Energy_i$Absolute.Google.Search.Volume)

#bc_obj<-boxcox(Oil_m$Price)
#Data_VECM$Oil_p<-predict(bc_obj)
Data_VECM$Oil_p<-log(Oil_m$Price)

Data_VECM$OFR<-Fs_m$Rate
Data_VECM$Renixx_rate<-renixx_m$Renixx
Data_VECM$MSCI_rate<-MSCI_m$Rate_ms

#bc_obj<-boxcox(Oil_m$Price)
#Data_VECM$Oil_p<-predict(bc_obj)
#Data_VECM$dummy_OFR<- as.numeric(ifelse(Data_VECM$OFR >=0,1,0))

#Data_VECM$Energy_i<-Data_VECM$Energy_i/max(Data_VECM$Energy_i)
#Data_VECM$Renixx<-Data_VECM$Renixx/max(Data_VECM$Renixx)
```

#2016 Oct.

```{r}
all_series<-ts(Data_VECM[c(121:216),c('Renixx','Energy_i','Oil_p',"Energy_s")],start=c(2015,1), end=c(2022,12),frequency=12)

var <- VARselect(all_series, type = "both", lag.max = 12, season = 12)
var$selection["FPE(n)"]

var_all = VAR(all_series,5, season = 12,type = 'both') #3 for cointegration
#summary(fitvar1)
summary(var_all)
#causality(var_eni, cause = "Oil_p")
causality(var_all, cause = "Renixx")
causality(var_all, cause = "Energy_i")
causality(var_all, cause = "Energy_s")
causality(var_all, cause = "Oil_p")
```

```{r}
library(goft)
res<-matrix(c(var_all[["varresult"]][["Renixx"]][["residuals"]],var_all[["varresult"]][["Energy_i"]][["residuals"]],var_all[["varresult"]][["Energy_s"]][["residuals"]],var_all[["varresult"]][["Oil_p"]][["residuals"]]), ncol = 4)
mvshapiro_test(res)
#plot(fitvar1)
vars::arch.test(var_all,multivariate.only = TRUE)   
normality.test(var_all,multivariate.only = TRUE)  
serial.test(var_all, type = "BG",lags.bg = 2)
plot(stability(var_all), nc = 2)

impresp <- irf(var_all)
plot(impresp)

plot(fevd(var_all),nr = 2)
fevd(var_all)
```

```{r}
nlags=5-1
jotest_all=ca.jo(all_series, type="eigen", K=nlags, ecdet="trend", spec= "transitory", season = 12)
summary(jotest_all)
jotest_all=ca.jo(all_series, type="trace", K=nlags, ecdet="trend", spec= "transitory", season = 12)
summary(jotest_all)
```

```{r}
library(tsDyn)
lttest(jotest_all, r=1)

y.VEC <- cajorls(jotest_all, r=1)
y.VEC
summary(y.VEC$rlm)


urca::plotres(jotest_all)
v0.VAR <- vec2var(jotest_all, r = 1)
v0.VAR
vars::arch.test(v0.VAR)   
normality.test(v0.VAR)  
serial.test(v0.VAR)
impresp <- irf(v0.VAR)
plot(impresp)

plot(fevd(v0.VAR))
fevd(v0.VAR)$Renixx
```


#Var_eni
```{r}
all_series<-ts(Data_VECM[c(121:216),c('Renixx','Energy_i')],start=c(2015,1), end=c(2022,12),frequency=12)
dumvar<-matrix(Data_VECM[c(121:216),c('Oil_p')],ncol=1,nrow=96,dimnames = list(c(1:96),c('Oil_p')))

var <- VARselect(all_series, type = "both", lag.max = 12, season = 12, exogen=dumvar)
var$selection["FPE(n)"]
#c('EPU','Geo_i','dummy_Renixx','dummy_Renixx2','Tech','Natural','OFR','Carbon_p','Warming','Green_e')
var_eni = VAR(all_series,3, season = 12,type = 'both',exogen=dumvar) #3 for cointegration
#summary(fitvar1)
summary(var_eni)
#causality(var_eni, cause = "Oil_p")
causality(var_eni, cause = "Renixx")
causality(var_eni, cause = "Energy_i")
```

```{r}
res<-matrix(c(var_eni[["varresult"]][["Renixx"]][["residuals"]],var_eni[["varresult"]][["Energy_i"]][["residuals"]]), ncol = 2)
mvshapiro_test(res)
#plot(fitvar1)
vars::arch.test(var_eni,multivariate.only = TRUE)   
normality.test(var_eni,multivariate.only = TRUE)  
serial.test(var_eni, type = "BG",lags.bg = 12)
plot(stability(var_eni), nc = 2)

impresp <- irf(var_eni)
plot(impresp)

plot(fevd(var_eni),nr = 2)
fevd(var_eni)
```

```{r}
#SVAR
#https://kevinkotze.github.io/ts-8-svar/
#https://www.r-econometrics.com/timeseries/svarintro/
a <- diag(1, 2)
a[1,2] <- NA
svar<-SVAR(var_eni, Amat = a, max.iter = 10000)
solve(svar$A)

impresp_sv <- irf(svar)
plot(impresp_sv)

plot(fevd(svar))
```


```{r}
nlags <- 3-1
jotest_all=ca.jo(all_series, type="eigen", K=nlags, ecdet="trend", spec= "transitory", season = 12,dumvar =dumvar)
summary(jotest_all)
jotest_all=ca.jo(all_series, type="trace", K=nlags, ecdet="trend", spec= "transitory", season = 12,dumvar =dumvar)
summary(jotest_all)
```

```{r}
library(tsDyn)
lttest(jotest_all, r=1)

y.VEC <- cajorls(jotest_all, r=1)
y.VEC
summary(y.VEC$rlm)


urca::plotres(jotest_all)
```

```{r}
v1.VAR <- vec2var(jotest_all, r = 1)
v1.VAR
vars::arch.test(v1.VAR)   
normality.test(v1.VAR)  
serial.test(v1.VAR)
impresp <- irf(v1.VAR)
plot(impresp)

plot(fevd(v1.VAR))
fevd(v1.VAR)$Renixx
```

#Arimax eni

```{r}
library(aTSA)
library(tsoutliers)

all_series<-ts(Data_VECM[c(121:216),c('Renixx','Energy_i','Oil_p','Energy_s')],start=c(2015,1), end=c(2022,12),frequency=12)

arimax_eni<-auto.arima(all_series[,1],seasonal = TRUE, xreg=all_series[,c('Energy_i','Energy_s')])
arimax_eni
arimax_1<-Arima(all_series[,1], order = c(1,0,1), seasonal = list(order = c(0, 0, 0), period = 12),xreg =all_series[,c('Energy_i','Energy_s')])
summary(arimax_1)
coeftest(arimax_1)
```

```{r}
#Residuals
res<-arimax_1$residuals
plot(res)

#ts.diag(arimax_1, lag.seq = NULL)

McLeod.Li.test(object=arimax_1)
checkresiduals(arimax_1)
JarqueBera.test(arimax_1)

ncvTest.arima(arimax_1)
```

```{r}
spec <- ugarchspec(variance.model = list(model = "eGARCH",garchOrder = c(1, 1),external.regressors =matrix(all_series[,c('Energy_i','Energy_s')],ncol=2)),
mean.model=list(armaOrder=c(1,1),external.regressors =matrix(all_series[,c('Energy_i','Energy_s')],ncol=2),arfima=TRUE ),distribution.model="ghyp",fixed.pars=list(arfima = 0))
arimax_enigarch <- ugarchfit(spec = spec, data =all_series[,1],solver.control = list(trace=0),xreg=all_series[,c('Energy_i','Energy_s')])
arimax_enigarch
```

#Arima oil
```{r}
arimax_oil<-auto.arima(all_series[,1],seasonal = TRUE, xreg=all_series[,c('Oil_p')])
arimax_oil
arimax_2<-Arima(all_series[,1], order = c(1,1,1), seasonal = list(order = c(0, 0, 0), period = 12),xreg =all_series[,c('Oil_p')])
summary(arimax_2)
coeftest(arimax_2)
```

```{r}
library(TSA)
library(tsoutliers)
#Residuals
res<-arimax_2$residuals
plot(res)

#ts.diag(arimax_2, lag.seq = NULL)

McLeod.Li.test(object=arimax_2)
checkresiduals(arimax_2)
JarqueBera.test(arimax_2)

ncvTest.arima(arimax_2)
```
```{r}
spec <- ugarchspec(variance.model = list(model = "eGARCH",garchOrder = c(1, 1),external.regressors =matrix(all_series[,c('Oil_p')],ncol=1)),
mean.model=list(armaOrder=c(1,1),external.regressors =matrix(all_series[,c('Oil_p')],ncol=1),arfima=TRUE ),distribution.model="ghyp",fixed.pars=list(arfima = 1))
arimax_oilgarch <- ugarchfit(spec = spec, data =all_series[,1],solver.control = list(trace=0),xreg=all_series[,c('Oil_p')])
arimax_oilgarch
```

#Arima

```{r}
all_series<-ts(Data_VECM[c(121:216),'Renixx'],start=c(2015,1), end=c(2022,12),frequency =12)
arima_n<-auto.arima(all_series,seasonal = TRUE)
arima_n
arima<-Arima(all_series, order = c(1,1,1), seasonal = list(order = c(0, 0, 0), period = 12))
summary(arima)
```

```{r}
#Residuals
res<-arima$residuals
plot(res)

#ts.diag(arima, lag.seq = NULL)

McLeod.Li.test(object=arima)
checkresiduals(arima)
JarqueBera.test(arima)

ncvTest.arima(arima)
```

```{r}
#bc_obj<-boxcox(Energy_i$Absolute.Google.Search.Volume)
Energy_i <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Energy_index.csv", header=TRUE, comment.char="#")

Energy_1<-log(Energy_i$Absolute.Google.Search.Volume[229:234])

#Energy_1<-predict(bc_obj,Energy_i$Absolute.Google.Search.Volume[229:234])
#bc_obj<-boxcox(Energy_s$Absolute.Google.Search.Volume)
Energy_s <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Energy_shares.csv", header=TRUE, comment.char="#")
Energy_2<-log(Energy_s$Absolute.Google.Search.Volume[229:234])
#Energy_2<-predict(bc_obj,Energy_s$Absolute.Google.Search.Volume[229:234])

#bc_obj<-boxcox(Energy_i$Absolute.Google.Search.Volume+Energy_s$Absolute.Google.Search.Volume)
#Energy_im<-predict(bc_obj,c(Energy_i$Absolute.Google.Search.Volume[229:234]+Energy_s$Absolute.Google.Search.Volume[229:234]))

Oil_pred <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Oil_pred.csv", header=TRUE, comment.char="#")

Oil_pred$Date<-mdy(Oil_pred$Date)
df_p <- Oil_pred %>% dplyr::select(1,2)
Month<- as.Date(cut(df_p$Date, "month"))
Oil_pm <- aggregate(Price ~ Month, df_p, mean)

#bc_obj<-boxcox(Oil_m$Price)
Oil_pm<-log(Oil_pm$Price)

Exo<-data.frame(c(Energy_1),c(Oil_pm))
colnames(Exo)[1]<-'Energy_i'
colnames(Exo)[2]<-'Oil_p'
```

#Predictions

```{r}
garch_eni = ugarchforecast(arimax_enigarch, n.ahead = 6, external.forecasts=list(mregfor = matrix(c(Energy_1,Energy_2),ncol=2), vregfor = matrix(c(Energy_1,Energy_2),ncol=2)))
print(garch_eni)
plot(garch_eni)
as.numeric(garch_eni@forecast[["seriesFor"]])

garch_oil = ugarchforecast(arimax_oilgarch, n.ahead = 6, external.forecasts=list(mregfor = matrix(c(Oil_pm),ncol=1), vregfor = matrix(c(Oil_pm),ncol=1)))
print(garch_oil)
plot(garch_oil)
as.numeric(garch_oil@forecast[["seriesFor"]])
```

```{r}
pred_varall<- predict(var_all, n.ahead = 6)
autoplot(pred_varall)+ facet_wrap(~variable, ncol = 1, scales = "free_y")

pred_arimaoil <- predict(var_eni, n.ahead = 6,dumvar=matrix(c(Oil_pm),ncol=1))
autoplot(pred_arimaoil)+ facet_wrap(~variable, ncol = 1, scales = "free_y")

pred_arimaeni<-forecast::forecast(arimax_eni, h = 6,xreg=matrix(c(Energy_1,Energy_2),ncol=2))
autoplot(pred_arimaeni)

pred_arima<-forecast::forecast(arima_n, h = 6)
autoplot(pred_arima)

pred_arimaoil<-forecast::forecast(arimax_oil, h = 6,xreg=matrix(c(Oil_pm),ncol=1))
autoplot(pred_arimaoil)

dumvar<-matrix(c(Oil_pm),ncol=1,nrow=6,dimnames = list(c(1:6),c('Oil_p')))
v1.VAR.fcst <- predict(v1.VAR, n.ahead = 6,dumvar=dumvar)
autoplot(v1.VAR.fcst)+ facet_wrap(~variable, ncol = 1, scales = "free_y")

#v0.VAR.fcst <- predict(v0.VAR, n.ahead = 6)
#autoplot(v0.VAR.fcst)+ facet_wrap(~variable, ncol = 1, scales = "free_y")
```

```{r}
renixx_p <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/renixx_pred.csv")

#DESCRIPTIVE STATISTICS

renixx_p$date<-ymd(renixx_p$date)
ggplot(renixx_p, aes(date, close))+geom_line()+ggtitle('Renixx index future values')+xlab('Time')+ylab('Absolute Returns')
```

```{r}
library(Metrics)
#renixx_p <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/renixx_p.csv")

renixx_p$date<-ymd(renixx_p$date)
df_p <- renixx_p %>% dplyr::select(1,3)
Month<- as.Date(cut(df_p$date, "month"))
renixx_pm <- aggregate(close ~ Month, df_p, mean)

#bc_obj<-boxcox(renixx_m$close)
#renixx_pm$close<-predict(bc_obj,renixx_pm$close)
renixx_pm$close<-log(renixx_pm$close)

#New_arimax<-pred_arimaoil$mean+0.8608448*Energy_im

#rmse(renixx_pm$close[1],pred_varall$fcst$Renixx[1,1])
#rmse(renixx_pm$close[1],pred_arimaoil$mean[1])
#rmse(renixx_pm$close[1],pred_arimaeni$mean[1])
#rmse(renixx_pm$close[1],v1.VAR.fcst$fcst$Renixx[1,1])
#
#mape(renixx_pm$close[1],pred_varall$fcst$Renixx[1,1])
#mape(renixx_pm$close[1],pred_arimaoil$mean[1])
#mape(renixx_pm$close[1],pred_arimaeni$mean[1])
#mape(renixx_pm$close[1],v1.VAR.fcst$fcst$Renixx[1,1])

rmse(renixx_pm$close,pred_varall$fcst$Renixx[,1])
#rmse(renixx_pm$close,pred_arimaoil$fcst$Renixx[,1])
#rmse(renixx_pm$close,pred_arimaeni$mean)
rmse(renixx_pm$close,pred_arima$mean)
#rmse(renixx_pm$close,pred_arimaoil$mean)
rmse(renixx_pm$close,v1.VAR.fcst$fcst$Renixx[,1])
rmse(renixx_pm$close,as.numeric(garch_eni@forecast[["seriesFor"]]))
rmse(renixx_pm$close,as.numeric(garch_oil@forecast[["seriesFor"]]))

mape(renixx_pm$close,pred_varall$fcst$Renixx[,1])
#mape(renixx_pm$close,pred_arimaoil$fcst$Renixx[,1])
#mape(renixx_pm$close,pred_arimaeni$mean)
mape(renixx_pm$close,pred_arima$mean)
mape(renixx_pm$close,pred_arimaoil$mean)
mape(renixx_pm$close,v1.VAR.fcst$fcst$Renixx[,1])
mape(renixx_pm$close,as.numeric(garch_eni@forecast[["seriesFor"]]))
rmse(renixx_pm$close,as.numeric(garch_oil@forecast[["seriesFor"]]))
```

#Finance implications
```{r}
all_series<-ts(Data_VECM[c(1:216),c('Renixx_rate','OFR')],start=c(2005,1), end=c(2022,12),frequency=12)

var <- VARselect(all_series, type = "none", lag.max = 12, season = 12)
var$selection["FPE(n)"]

var_OFR = VAR(all_series,3, season = 12,type = 'none') #3 for cointegration
#summary(fitvar1)
summary(var_OFR)
causality(var_OFR, cause = "OFR")
causality(var_OFR, cause = "Renixx_rate")
```





########################################################### 

#Scenario analysis

```{r}
Var_scenario = VAR(all_series,4, season = 12,type = 'both',exogen = Data_VECM[c(121:215),c('Energy_s','Green_e')])

Var_scenario<-restrict(Var_scenario, method = "ser")
summary(Var_scenario)

res<-matrix(c(Var_scenario[["varresult"]][["Renixx"]][["residuals"]],Var_scenario[["varresult"]][["Energy_i"]][["residuals"]]), ncol = 2)
mvshapiro_test(res)

#plot(Var_scenario)
arch.test(Var_scenario,multivariate.only = TRUE)   
normality.test(Var_scenario,multivariate.only = TRUE)  
serial.test(Var_scenario, type = "BG",lags.bg = 12)
plot(stability(Var_scenario), nc = 2)


dumvar<-matrix(c(seq(9.8,9.40,length=12),seq(13.2,12.39,length=12)),ncol=2)
Var_scenariop<- predict(Var_scenario, n.ahead = 12,dumvar =dumvar)
autoplot(Var_scenariop)+ facet_wrap(~variable, ncol = 1, scales = "free_y")
```

#SVECM

```{r}
SR <- matrix(1, nrow = 2, ncol = 2)
SR[2, 1] <- 0
SR[1, 2] <- NA
LR <- matrix(1, nrow = 2, ncol = 2)
LR[2,1] <- NA
LR[1,2] <- NA

jotest_all<-ca.jo(all_series, type="eigen", K=2, ecdet="trend", spec= "transitory", season = 12,dumvar =dumvar)

svec <- SVEC(jotest_all, LR = LR, SR = SR, r = 1, boot = TRUE,lrtest = FALSE,runs = 100)
summary(svec)
impresp <- irf(svec)
plot(impresp)

plot(fevd(svec))
fevd(svec)$Renixx
```

#Scenario analysis

```{r}
Var_scenario = VAR(all_series,4, season = 12,type = 'both',exogen = Data_VECM[c(121:215),c('Energy_s','Green_e')])

Var_scenario<-restrict(Var_scenario, method = "ser")
summary(Var_scenario)

res<-matrix(c(Var_scenario[["varresult"]][["Renixx"]][["residuals"]],Var_scenario[["varresult"]][["Energy_i"]][["residuals"]]), ncol = 2)
mvshapiro_test(res)

#plot(Var_scenario)
arch.test(Var_scenario,multivariate.only = TRUE)   
normality.test(Var_scenario,multivariate.only = TRUE)  
serial.test(Var_scenario, type = "BG",lags.bg = 12)
plot(stability(Var_scenario), nc = 2)


dumvar<-matrix(c(seq(9.8,9.40,length=12),seq(13.2,12.39,length=12)),ncol=2)
Var_scenariop<- predict(Var_scenario, n.ahead = 12,dumvar =dumvar)
autoplot(Var_scenariop)+ facet_wrap(~variable, ncol = 1, scales = "free_y")
```

#VAR-VECM

```{r}
library(tsDyn)
lttest(jotest_all, r=4)

y.VEC <- cajorls(jotest_all, r=4)
y.VEC
summary(y.VEC$rlm)

urca::plotres(jotest_all)

```

```{r}
v1.VAR <- vec2var(jotest_all, r = 1)
v1.VAR
arch.test(v1.VAR)   
normality.test(v1.VAR)  
serial.test(v1.VAR)
impresp <- irf(v1.VAR)
plot(impresp)

plot(fevd(v1.VAR))
fevd(v1.VAR)$Renixx
```

```{r}
v1.VAR.fcst <- predict(v1.VAR, n.ahead = 7)
autoplot(v1.VAR.fcst)+ facet_wrap(~variable, ncol = 1, scales = "free_y")
```

```{r}
#rest_betta <-matrix(data = c(1,0,0,0,
#                0,1,1,0,
#                0,0,0,1
#                ),
#       nrow = 4, ncol = 3)
#blrtest(jotest_all, H = rest_betta, r = 1) %>% summary()
#summary(y.VEC$rlm)
#
#rest_alpha <- matrix(data = c(0,1,0), nrow = 3, ncol = 1)
#ablrtest(jotest_all, A = rest_alpha, H = rest_betta, r = 1) %>% summary()
#
#VECM_rest <- ablrtest(jotest_all, A = rest_alpha, H = rest_betta, r = 1)
#jotest_rest <- cajorls(VECM_rest, r = 1)
#jotest_rest

```

```{r}
v1.VAR <- vec2var(jotest_all, r = 1)
arch.test(v1.VAR)   
normality.test(v1.VAR)  
serial.test(v1.VAR)
impresp <- irf(v1.VAR)
plot(impresp)

plot(fevd(v1.VAR))
fevd(v1.VAR)$Renixx
```

```{r}
#ratesa<-Data[1:130,]
#ratesa$Month<-NULL;
##ratesa$Date<-NULL
#library(dtw);
#tr<-t(ratesa);
#distMatrix <- dist(tr);
## hierarchical clustering
#hc <- hclust(distMatrix, method="ward.D2")
#plot(hc, main="Clustering by distance")
#
#ratesa<-Data[130:173,]
#ratesa$Month<-NULL;
##ratesa$Date<-NULL
#library(dtw);
#tr<-t(ratesa);
#distMatrix <- dist(tr);
## hierarchical clustering
#hc <- hclust(distMatrix, method="ward.D2")
#plot(hc, main="Clustering by distance")
#
#ratesa<-Data[173:211,]
#ratesa$Month<-NULL;
##ratesa$Date<-NULL
#library(dtw);
#tr<-t(ratesa);
#distMatrix <- dist(tr);
## hierarchical clustering
#hc <- hclust(distMatrix, method="ward.D2")
#plot(hc, main="Clustering by distance")
```

```{r}
#Climate$Green_e<-c(0,diff(log(Climate$Green_e)))
#Climate$Green_elag<-c(0,diff(log(Climate$Green_elag)))
#Climate$Energy_i<-c(0,diff(log(Climate$Energy_i)))
#Climate$Energy_ilag<-c(0,diff(log(Climate$Energy_ilag)))
#Climate$Warming<-c(0,diff(log(Climate$Warming)))
#Climate$Warminglag<-c(0,diff(log(Climate$Warminglag)))
#Climate$Carbon_p<-c(0,diff(log(Climate$Carbon_p)))
#Climate$Carbon_plag<-c(0,diff(log(Climate$Carbon_plag)))
#Climate$Natural<-c(0,diff(log(Climate$Natural)))
#Climate$Naturallag<-c(0,diff(log(Climate$Naturallag)))
#Climate$Tech<-c(0,diff(log(Climate$Tech)))
#Climate$Techlag<-c(0,diff(log(Climate$Techlag)))
#Climate$Tran_r<-c(0,diff(log(Climate$Tran_r)))
#Climate$Tran_rlag<-c(0,diff(log(Climate$Tran_rlag)))

#Finance$Merge<-format(as.Date(Finance$Month), "%Y-%m")
#Climate$Merge<-format(as.Date(Climate$Date), "%Y-%m")

#Data<-merge(Finance,Climate,by="Merge")
#Data <- Data[c(10:211),-c(1,23)]
#rownames(Data) <- NULL
#416:934

Data_3<-Data[c(1:215),c(1:length(Data[1,]))]
rownames(Data_3) <- NULL

adf1 <- summary(ur.df(Data_3[,"Renixx"], type = "drift",lags = 10, selectlags = "AIC"))
adf1
adf2 <- summary(ur.df(Data_3[, "Oil_p"], type = "drift",lags = 10, selectlags = "AIC"))
adf2
adf3 <- summary(ur.df(Data_3[, "Geo_i"], type = "drift", lags = 10, selectlags = "AIC"))
adf3
adf4 <- summary(ur.df(Data_3[, "MSCI"], type = "drift", lags = 10, selectlags = "AIC"))
adf4
#adf5 <- summary(ur.df(Data_3[, "Tran_r"], type = "drift", lags = 10, selectlags = "AIC"))
#adf5
adf6 <- summary(ur.df(Data_3[, "Tech"], type = "drift", lags = 10, selectlags = "AIC"))
adf6
adf7 <- summary(ur.df(Data_3[, "Energy_i"], type = "drift", lags = 10, selectlags = "AIC"))
adf7
adf8 <- summary(ur.df(Data_3[, "Warming"], type = "drift", lags = 10, selectlags = "AIC"))
adf8
adf9 <- summary(ur.df(Data_3[, 'Carbon_p'], type = "drift", lags = 10, selectlags = "AIC"))
adf9
adf10 <- summary(ur.df(Data_3[, 'Natural'], type = "drift", lags = 10, selectlags = "AIC"))
adf10
adf11 <- summary(ur.df(Data_3[, 'Green_e'], type = "drift", lags = 10, selectlags = "AIC"))
adf11

#sapply(Data[c(1:202),], anyNA)
```

```{r}
library(vars)
value <- VARselect(Data_3[c(116:202),c(2:13)], lag.max = 12, season = 12)
fitvar1 = VAR(Data_3[c(116:202),c(2:13)], p=value$selection[4], season = 12)
summary(fitvar1)

 #restrict<-matrix(c(1,0,0,0,0,0,0,0,0,0, 
 #                 0,1,0,0,1,0,0,0,0,0,
 #                 1,1,0,0,0,0,0,0,0,0,
 #                 0,0,0,0,1,1,0,0,0,0,
 #                 0,0,0,0,1,0,0,0,0,0,
 #                 0,0,0,0,0,0,1,1,0,1,
 #                 0,0,0,0,0,0,0,0,0,0,
 #                 0,0,1,0,0,1,0,1,0,0,
 #                 0,0,0,0,0,0,1,0,1,0,
 #                 0,0,0,0,0,0,0,0,0,0,0), nrow=10,ncol=101,byrow=TRUE)
 
Var_r<-restrict(fitvar1, method = "ser")
summary(Var_r)
```

```{r}
ser11 <- serial.test(Var_r, lags.pt = 12, type = "PT.asymptotic")
ser11$serial

norm1 <- normality.test(Var_r)
norm1$jb.mul$JB
norm1$jb.mul$Skewness
norm1$jb.mul$Kurtosis
plot(Var_r, names = "e")

arch1 <- arch.test(Var_r, lags.multi = 5)
arch1$arch.mul

plot(arch1, names = "MSCI")
#plot(stability(Var_r), nc = 2)

impresp <- irf(Var_r, impulse = 'Renixx', response = 'MSCI')
plot(impresp)

impresp <- irf(Var_r, impulse = c('Green_e','Warming','Natural','Tech','Carbon_p','Energy_i'), response = 'Renixx')
plot(impresp)

fevd<-fevd(Var_r)
fevd
```

```{r}
#value<-VARselect(Data[c(169:202),c('Renixx','Oil_p','Geo_i','MSCI','Tran_r','Tech','Climate','Natural','Carbon_p','Warming','Green_e')], lag.max = 2)
#var_all = VAR(Data[c(169:202),c('Renixx','Oil_p','Geo_i','MSCI','Tran_r','Tech','Climate','Natural','Carbon_p','Warming','Green_e')], p=value$selection[1])
#summary(var_all)

 #restrict<-matrix(c(1,0,0,0,0,0,0,0,0,0, 
 #                 0,1,0,0,1,0,0,0,0,0,
 #                 1,1,0,0,0,0,0,0,0,0,
 #                 0,0,0,0,1,1,0,0,0,0,
 #                 0,0,0,0,1,0,0,0,0,0,
 #                 0,0,0,0,0,0,1,1,0,1,
 #                 0,0,0,0,0,0,0,0,0,0,
 #                 0,0,1,0,0,1,0,1,0,0,
 #                 0,0,0,0,0,0,1,0,1,0,
 #                 0,0,0,0,0,0,0,0,0,0,0), nrow=10,ncol=101,byrow=TRUE)
 
#Var_r2 <- restrict(var_all, method = "ser")
#summary(Var_r2)
```

```{r}
#ser11 <- serial.test(Var_r2, type = "PT.asymptotic")
#ser11$serial

#norm1 <- normality.test(Var_r2)
#norm1$jb.mul$JB
#norm1$jb.mul$Skewness
#norm1$jb.mul$Kurtosis
#plot(Var_r2, names = "Renixx")
```

```{r}
#Data$Oil_lagp<-Oil_m$Rate_s[2:216]
#Data$MSCIlag<-MSCI_m$Rate_s[2:216]
#Data$EPUlag<-GEPUCURRENT$Rate_s[2:216]
#Data$Geo_lagi<-geo_m$St[2:216]

#green_e$Rate_s<-scale(c(0,diff(green_e$Absolute.Google.Search.Volume)),center = #TRUE,scale=TRUE)
#Data$Green_elag<-green_e[12:227,5][2:216]
#
#tech_d$Rate_s<-scale(c(0,diff(tech_d$Absolute.Google.Search.Volume)),center = #TRUE,scale=TRUE)
#Data$Techlag<-tech_d[12:227,5][2:216]
#
#Energy_i$Rate_s<-scale(c(0,diff(Energy_i$Absolute.Google.Search.Volume)),TRUE,sc#ale=TRUE)
#Data$Energy_ilag<-Energy_i[12:227,5][2:216]
#
#global_w$Rate_s<-scale(c(0,diff(global_w$Absolute.Google.Search.Volume)),TRUE,sc#ale=TRUE)
#Data$Warminglag<-global_w[12:227,5][2:216]
#
#Natural$Rate_s<-scale(c(0,diff(Natural$Absolute.Google.Search.Volume)),TRUE,scal#e=TRUE)
#Data$Naturallag<-Natural[12:227,5][2:216]
#
#Carbon_p$Rate_s<-c(0,diff(Carbon_p$Absolute.Google.Search.Volume))
#Data$Carbon_plag<-Carbon_p[12:227,5][2:216]

#value<-quantile(abs(Data$Renixxlag),probs=0.5)
#Data_2$dummy_Renixxlag<-as.factor(ifelse(abs(Data$Renixxlag) >= value, 1,0))
#Data_2$dummy_Renixxlag2<-as.factor(ifelse(abs(Data$Renixxlag2) >= value, 1,0))
#Data_2$dummy_Renixxlag3<-as.factor(ifelse(abs(Data$Renixxlag3) >= value, 1,0))
#Data_2$dummy_Renixxlag4<-as.factor(ifelse(abs(Data$Renixxlag4) >= value, 1,0))

#p_1<-0.8
#p_2<-0.2
#value<-quantile(Data$Oil_lagp,probs=p_1)
#value_2<-quantile(Data$Oil_lagp,probs=p_2)
#Data_2$dummy_Oillag<-as.factor(ifelse(Data$Oil_lagp >= value|Data$Oil_lagp <= value_2, 1,0))
#Data_2$dummy_Oillag2<-as.factor(ifelse(abs(Data$Oil_lag2p) >= value, 1,0))
#Data_2$dummy_Oillag3<-as.factor(ifelse(abs(Data$Oil_lag3p) >= value, 1,0))
#Data_2$dummy_Oillag4<-as.factor(ifelse(abs(Data$Oil_lag4p) >= value, 1,0))

#value<-quantile(Data$EPUlag,probs=p_1)
#value_2<-quantile(Data$EPUlag,probs=p_2)
#Data_2$dummy_EPUlag<-as.factor(ifelse(Data$EPUlag >= value|Data$EPUlag <= #value_2, 1,0))
#Data_2$dummy_EPUlag2<-as.factor(ifelse(abs(Data$EPUlag2) >= value, 1,0))
#Data_2$dummy_EPUlag3<-as.factor(ifelse(abs(Data$EPUlag3) >= value, 1,0))
#Data_2$dummy_EPUlag4<-as.factor(ifelse(abs(Data$EPUlag4) >= value, 1,0)))

#value<-quantile(Data$Geo_lagi,probs=p_1)
#value_2<-quantile(Data$Geo_lagi,probs=p_2)
#Data_2$dummy_Geo_lagi<-as.factor(ifelse(Data$Geo_lagi >= value|Data$Geo_lagi <= #value_2, 1,0))
#Data_2$dummy_Geo_lag2i<-as.factor(ifelse(abs(Data$Geo_lag2i) >= value, 1,0))
#Data_2$dummy_Geo_lag3i<-as.factor(ifelse(abs(Data$Geo_lag3i) >= value, 1,0))
#Data_2$dummy_Geo_lag4i<-as.factor(ifelse(abs(Data$Geo_lag4i) >= value, 1,0))

#value<-quantile(abs(Data$MSCIlag),probs=p_1)
#Data_2$dummy_MSCIlag<-as.factor(ifelse(Data$MSCIlag >= value|Data$MSCIlag <= #value_2, 1,0))
#Data_2$dummy_MSCIlag2<-as.factor(ifelse(abs(Data$MSCIlag2) >= value, 1,0))
#Data_2$dummy_MSCIlag3<-as.factor(ifelse(abs(Data$MSCIlag3) >= value, 1,0))
#Data_2$dummy_MSCIlag4<-as.factor(ifelse(abs(Data$MSCIlag4) >= value, 1,0))

#value<-quantile(abs(Data$Tran_r),probs=p_15)
#Data_2$Tran_rlag<-as.factor(ifelse(abs(Data$Tran_lagr) >= value, 1,0))
#Data_2$dummy_Tran_lag2r<-as.factor(ifelse(abs(Data$Tran_lag2r) >= value, 1,0))
#Data_2$dummy_Tran_lag3r<-as.factor(ifelse(abs(Data$Tran_lag3r) >= value, 1,0))
#Data_2$dummy_Tran_lag4r<-as.factor(ifelse(abs(Data$Tran_lag4r) >= value, 1,0))

#value<-quantile(abs(Data$Techlag),probs=p_1)
#Data_2$Techlag<-as.factor(ifelse(Data$Techlag >= value|Data$Techlag<= value_2, #1,0))
#Data_2$Techlag2<-as.factor(ifelse(abs(Data$Techlag2) >= value, '1','0'))
#Data_2$Techlag3<-as.factor(ifelse(abs(Data$Techlag3) >= value, '1','0'))
#Data_2$Techlag4<-as.factor(ifelse(abs(Data$Techlag4) >= value, '1','0'))

#value<-quantile(Data$OFRlag,probs=p_1)
#value_2<-quantile(Data$OFRlag,probs=p_2)
#Data_2$dummy_OFRlag<-as.factor(ifelse(Data$OFRlag >= value|Data$OFRlag <= #value_2, 1,0))
#Data_2$dummy_MSCIlag2<-as.factor(ifelse(abs(Data$MSCIlag2) >= value, 1,0))
#Data_2$dummy_MSCIlag3<-as.factor(ifelse(abs(Data$MSCIlag3) >= value, 1,0))
#Data_2$dummy_MSCIlag4<-as.factor(ifelse(abs(Data$MSCIlag4) >= value, 1,0))

#value<-quantile(Data$Green_elag,probs=p_1)
#value_2<-quantile(Data$Green_elag,probs=p_2)
#Data_2$Green_elag<-as.factor(ifelse(Data$Green_elag >= value|Data$Green_elag<= #value_2, 1,0))

#value<-quantile(Data$Energy_ilag,probs=p_1)
#value_2<-quantile(Data$Energy_ilag,probs=p_2)
#Data_2$Energy_ilag<-as.factor(ifelse(Data$Energy_ilag >= value|Data$Energy_ilag <= value_2, 1,0))

#value<-quantile(Data$Warminglag,probs=p_1)
#value_2<-quantile(Data$Warminglag,probs=p_2)
#Data_2$Warminglag<-as.factor(ifelse(Data$Warminglag >= value|Data$Warminglag<= #value_2, 1,0))

#value<-quantile(Data$Naturallag,probs=p_1)
#value_2<-quantile(Data$Naturallag,probs=p_2)
#Data_2$Naturallag<-as.factor(ifelse(Data$Naturallag >= value|Data$Naturallag<= #value_2, 1,0))

#value<-quantile(Data$Carbon_plag,probs=p_1)
#value_2<-quantile(Data$Carbon_plag,probs=p_2)
#Data_2$Carbon_plag<-as.factor(ifelse(Data$Carbon_plag >= value|Data$Carbon_plag<= value_2, #1,0))

#value<-quantile(Data$Techlag,probs=p_1)
#value_2<-quantile(Data$Techlag,probs=p_2)
#Data_2$Techlag<-as.factor(ifelse(Data$Techlag >= value|Data$Techlag<= value_2, #1,0))

#value<-quantile(Data$Factor_climate,probs=p_1)
#value_2<-quantile(Data$Factor_climate,probs=p_2)
#Data_2$Factor_climate<-as.factor(ifelse(Data$Factor_climate >= value|Data$Factor_climate<= value_2, 1,0))

#value<-quantile(Data$Factor_finance,probs=p_1)
#value_2<-quantile(Data$Factor_finance,probs=p_2)
#Data_2$Factor_finance<-as.factor(ifelse(Data$Factor_finance >= value|Data$Factor_finance<= value_2, 1,0))

#Data_2$EPUlag<-as.factor(ifelse(Data$EPUlag >= 0, 1,0))
#Data_2$OFRlag<-as.factor(ifelse(Data$OFRlag >= 0, 1,0))
#Data_2$Oil_lag<-as.factor(ifelse(Data$Oil_lag >= 0, 1,0))
#Data_2$Geo_lagi<-Data_2$OFRlag<-as.factor(ifelse(Data$Geo_lagi >= 0, 1,0))
#Data_2$Climatelag<-as.factor(ifelse(Data$Climatelag >= 0, 1,0))
#Data_2$Warminglag<-as.factor(ifelse(Data$Warminglag >= 0, 1,0))
#Data_2$Naturallag<-as.factor(ifelse(Data$Naturallag >= 0, 1,0))
#Data_2$Green_elag<-as.factor(ifelse(Data$Green_elag >= 0, 1,0))
#Data_2$Carbon_plag<-as.factor(ifelse(Data$Carbon_plag >= 0, 1,0))
#Data_2$Techlag<-as.factor(ifelse(Data$Techlag >= 0, 1,0))

#Data_2$Renixxlag<-abs(Data$Renixxlag)
#Data_2$Oil_lag<-abs(Data$Oil_lagp)
#Data_2$Geo_lagi<-abs(Data$Geo_lagi)
#Data_2$MSCIlag<-abs(Data$MSCIlag)
#Data_2$EPUlag<-abs(Data$EPUlag)
#Data_2$OFRlag<-abs(Data$OFRlag)
#Data_2$Energy_ilag<-abs(Data$Energy_ilag)
#Data_2$Warminglag<-abs(Data$Warminglag)
#Data_2$Naturallag<-abs(Data$Naturallag)
#Data_2$Green_elag<-abs(Data$Green_elag)
#Data_2$Carbon_plag<-abs(Data$Carbon_plag)
#Data_2$Techlag<-abs(Data$Techlag)
```

```{r}
#v<-36
#v_1<-v-1
#cor<-matrix(ncol=1,nrow=length(Data[,1])-v)
#for(i in v:c(length(Data[,1]))){
#  cor[i-v_1]<-sum(abs(cor(x = Data$Renixx[c(i-v_1):i], y #=Data[c(i-v_1):i,c(7:14)],method='kendall')))
#}
#plot(Data$Month[v:215],exp(cor),type='l')
#abline(v=Data_or$Month[135])
#abline(v=Data_or$Month[177])
#
#plot(Data_or$Month[v:216],Data_or$Renixx[v:216],type='l')

#v<-36
#v_1<-v-1
#cor<-matrix(ncol=1,nrow=length(Data_or[,1])-v)
#for(i in v:c(length(Data_or[,1]))){
#  cor[i-v_1]<-cor(Data_or$Renixx[c(i-v_1):i],Data_or$Energy_i[c(i-v_1):i],method='kendal')
#}
#plot(Data_or$Month[v:216],abs(cor),type='l')
#abline(v=Data_or$Month[135])
#abline(v=Data_or$Month[177])
#
#plot(Data_or$Month[v:216],Data_or$Renixx[v:216],type='l')


#v<-36
#v_1<-v-1
#cor<-matrix(ncol=1,nrow=length(Data_FA[,1])-v)
#for(i in v:c(length(Data_FA[,1]))){
#  cor[i-v_1]<-cor(Data_FA$Renixx[c(i-v_1):i],Data_FA$Energy_ilag[c(i-v_1):i],method='kendal')
#}
#plot(Data_FA$Month[v:215],abs(cor),type='l')
#abline(v=Data_or$Month[135])
#abline(v=Data_or$Month[177])
#
#plot(Data_or$Month[v:216],Data_or$Renixx[v:216],type='l')
```

#XGBoost

```{r}
#tunning parameters
train.data  <- Data_2[c(1:160), ] #1:774
vali.data <- Data_2[c(161:197), ] #775:834
test.data <- Data_2[c(198:215), ] #834:934

label = as.integer(Data_2$dummy_Renixx)-1
train.label = label[c(1:160)]
test.label = label[c(161:197)]
val.label = label[c(198:215)]

train = data.matrix(train.data[,-1])
test = data.matrix(vali.data[,-1])
val = data.matrix(test.data[,-1])

xgb_train = xgb.DMatrix(data = train, label=train.label)
xgb_test = xgb.DMatrix(data = test, label=test.label)
xgb_val = xgb.DMatrix(data = val, label=val.label)

watchlist = list(train=xgb_train, test=xgb_test)
```

```{r}
#create hyperparameter grid
max.depths = seq(1,6,by=1)
etas = seq(0.1,6,by=0.1)

best_params = 0
best_score = 0

count = 1
for( depth in max.depths ){
    for( num in etas){

        bst_grid = xgb.train(data = xgb_train, 
                                max.depth = depth, 
                                eta=num, 
                                nthread = 2, 
                                nround = 1000, 
                                watchlist = watchlist, 
                                #objective = "reg:squarederror", 
                                early_stopping_rounds = 50, 
                                verbose=0,
                                booster="gbtree",
                                objective="multi:softprob",
                                eval_metric="mlogloss",
                                num_class=2
                                )

        if(count == 1){
            best_params = bst_grid$params
            best_score = bst_grid$best_score
            count = count + 1
            }
        else if(bst_grid$best_score < best_score){
            best_params = bst_grid$params
            best_score = bst_grid$best_score
        }
    }
}

best_params
best_score
```

```{r}
#fit XGBoost model and display training and testing data at each iteartion
#xgb.train(data = xgb_train, max.depth = 2, watchlist=watchlist, nrounds = 1000)

model_xgb = xgb.train(data = xgb_train, nthread = 2, eta = best_params$eta, max.depth = best_params$max_depth, nrounds = 1000, watchlist = watchlist, early_stopping_rounds = 50,  verbose = 1,booster="gbtree", objective="multi:softprob",eval_metric="mlogloss", num_class=2)

summary(model_xgb)

vali_pred = predict(model_xgb, xgb_test)
vali_prediction <- matrix(vali_pred, nrow = 2,
                          ncol=length(vali_pred)/2) %>%
  t() %>%
  data.frame() %>%
  mutate(label = test.label + 1,
         max_prob = max.col(., "last"))

confusionMatrix(factor(vali_prediction$max_prob),
                factor(vali_prediction$label),
                mode = "everything")


test_pred = predict(model_xgb, xgb_val)
test_prediction <- matrix(test_pred, nrow = 2,
                          ncol=length(test_pred)/2) %>%
  t() %>%
  data.frame() %>%
  mutate(label = val.label + 1,
         max_prob = max.col(., "last"))

test_prediction$max_prob
test_prediction$label
```

```{r}
importance <- xgb.importance(feature_names = colnames(xgb_test),model = model_xgb)
print(xgb.ggplot.importance(importance_matrix = importance))
```

#Logit model

```{r}
# Find the best lambda using cross-validation
set.seed(123) 
cv.lasso <- cv.glmnet(x, y, alpha = 1, family = "binomial",standardize=TRUE,intercept=FALSE)
# Fit the final model on the training data
model <- glmnet(x, y, alpha = 1, family = "binomial",
                lambda = cv.lasso$lambda.min,standardize=TRUE,intercept=FALSE)
# Display regression coefficients
coefList<-coef(model)

coefList <- data.frame(coefList@Dimnames[[1]][coefList@i+1],coefList@x)
names(coefList) <- c('var','val')

coefList %>%
  arrange(-abs(val)) %>%
  print(.,n=25)

library(plotmo)
plot_glmnet(cv.lasso$glmnet.fit, label=TRUE)
```

```{r}
model_f<-glm(dummy_Renixx ~Techlag+Energy_ilag+Green_elag+Carbon_plag+Naturallag+Warminglag+Oil_plag+OFRlag, family = binomial(link = "logit"), data = Data_2)
model_0<-glm(dummy_Renixx ~1, family = binomial(link = "logit"), data = Data_2)
model_2<-glm(dummy_Renixx ~Carbon_plag+Green_elag+Energy_ilag+Oil_plag, family = binomial(link = "logit"), data = Data_2)
summary(model_2)
model_2$deviance
-2*logLik(model_2)

vif(model_2)
lrtest (model_0, model_2)
lrtest (model_2, model_f)
blr_linktest(model_2)

y_hat2 <- predict(model_2, type='response')
mean((y_hat2 >= 0.5 & Data_2[,]$dummy_Renixx==0) | (y_hat2 < 0.5 & Data_2[,]$dummy_Renixx==1))
1 - max(prop.table(table(Data_2[,]$dummy_Renixx)))

list(model = pscl::pR2(model_2)["McFadden"])

model1_data <- augment(model_2) %>% mutate(index = 1:n())

ggplot(model1_data, aes(index, .std.resid, color = dummy_Renixx)) + 
  geom_point(alpha = .5) +
  geom_ref_line(h = 3)

exp(coef(model_2))
logistic.display(model_2)
or_glm(data = Data_2, model = model_2, incr = c(Naturallag=0.1,Green_elag=0.1,Energy_ilag=0.1,Techlag=0.1,Carbon_plag=0.1,Warminglag=0.1,Oil_plag=0.1))
```

```{r}
#Data_2<-renixx_m[c(2:216),c(1,4)]
#colnames(Data_2)[2] <- "Renixx"
#Data_2$dummy_Renixx <- as.factor(ifelse(Data_2$Month >= "2016-03-01" & #Data_2$Month <= "2019-10-01", 0,ifelse(Data_2$Month > "2005-01-01" & #Data_2$Month <= "2016-03-01"| Data_2$Month > "2019-10-01", 1,1)))
#Data_2$Energy_ilag<-lag(Data_or$Energy_i)[2:216]
#Data_2$Warminglag<-lag(Data_or$Warming)[2:216]
#Data_2$Naturallag<-lag(Data_or$Natural)[2:216]
#Data_2$Green_elag<-lag(Data_or$Green_e)[2:216]
#Data_2$Carbon_plag<-lag(Data_or$Carbon_p)[2:216]
#Data_2$Techlag<-lag(Data_or$Tech)[2:216]
#Data_2<-Data_2[,-c(1,2)]
#
#rownames(Data_2) <- NULL
#
##for (i in 1:21){
##  Data_2[,i]<-as.numeric(Data_2[,i])-1
##}
#
#str(Data_2)
#Data_2$Oil_plag<-lag(Data_or$Oil_p)[2:216]
#Data_2$OFRlag<-lag(Data_or$EPU)[2:216]
```

```{r}
#p1 <- ggplot(Data_2[c(1:177),], aes(x=Green_elag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx))+ labs(fill='Green_e bubble')+
#      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Green_e Energy')
#
#p2 <- ggplot(Data_2[c(1:177),], aes(x=Naturallag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4)+
#      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Natural #disasters')+ labs(fill='Green_e bubble') 
#
#p3 <- ggplot(Data_2[c(1:177),], aes(x=Carbon_plag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) + xlab('Carbon #price')+
#      guides(color = "none")+ geom_density(alpha=0.4) + labs(fill='Green_e #bubble') 
#
#p4 <- ggplot(Data_2[c(1:177),], aes(x=Energy_ilag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
#      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Energy Index')+ #labs(fill='Green_e bubble')
#
#p5 <- ggplot(Data_2[c(1:177),], aes(x=Warminglag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
#      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Global Warming')+ #labs(fill='Green_e bubble')
#
#p6 <- ggplot(Data_2[c(1:177),], aes(x=Techlag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
#      guides(color = "none")+ geom_density(alpha=0.4) + xlab('New Technology')+ #labs(fill='Green_e bubble')
#p7 <- ggplot(Data_2[c(1:177),], aes(x=OFRlag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
#     guides(color = "none")+ geom_density(alpha=0.4) + xlab('OFR')+ #labs(fill='Green_e bubble')
#p8 <- ggplot(Data_2[c(1:177),], aes(x=Oil_plag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
#     guides(color = "none")+ geom_density(alpha=0.4) + xlab('Oil price')+ #labs(fill='Green_e bubble')
#grid.arrange(p1, p2, p3, p4, p5, p6,p7,p8, ncol=2)
```

```{r}
#p1 <- ggplot(Data_2[c(134:215),], aes(x=Green_elag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx))+ labs(fill='Green_e bubble')+
#      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Green_e Energy')
#
#p2 <- ggplot(Data_2[c(134:215),], aes(x=Naturallag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4)+
#      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Natural #disasters')+ labs(fill='Green_e bubble') 
#
#p3 <- ggplot(Data_2[c(134:215),], aes(x=Carbon_plag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) + xlab('Carbon #price')+
#      guides(color = "none")+ geom_density(alpha=0.4) + labs(fill='Green_e #bubble') 
#
#p4 <- ggplot(Data_2[c(134:215),], aes(x=Energy_ilag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
#      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Energy Index')+ #labs(fill='Green_e bubble')
#
#p5 <- ggplot(Data_2[c(134:215),], aes(x=Warminglag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
#      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Global Warming')+ #labs(fill='Green_e bubble')
#
#p6 <- ggplot(Data_2[c(134:215),], aes(x=Techlag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
#      guides(color = "none")+ geom_density(alpha=0.4) + xlab('New Technology')+ #labs(fill='Green_e bubble')
#p7 <- ggplot(Data_2[c(134:215),], aes(x=OFRlag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
#     guides(color = "none")+ geom_density(alpha=0.4) + xlab('OFR')+ #labs(fill='Green_e bubble')
#p8 <- ggplot(Data_2[c(134:215),], aes(x=Oil_plag, group=dummy_Renixx, #color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
#     guides(color = "none")+ geom_density(alpha=0.4) + xlab('Oil price')+ #labs(fill='Green_e bubble')
#grid.arrange(p1, p2, p3, p4, p5, p6,p7,p8, ncol=2)
#p7 <- ggplot(Data_2[c(130:211),], aes(x=Tran_rlag, group=dummy_Renixx, color=dummy_Renixx, fill=dummy_Renixx)) + geom_density(alpha=0.4) +
#      guides(color = "none")+ geom_density(alpha=0.4) + xlab('Transition risk')+ labs(fill='Green_e bubble')
```

#MWMOTE-ELASTICNET-LOGIT

```{r}
library(imbalance)
library(ROSE)

# Perform MWMOTE oversampling
oversampled_data <- mwmote(train.data, numInstances = 154, classAttr = "dummy_Renixx")

filteredSamples <- neater(train.data, oversampled_data, iterations = 100, classAttr = "dummy_Renixx")

#use SMOTE to create new dataset that is more balanced
train.data_new <- smote(dummy_Renixx ~ ., train.data, perc.over = 10, perc.under = 1)

# Combine the oversampled data with the original dataset
combined_data <- rbind(train.data, filteredSamples)

#view distribution of response variable in new dataset
table(combined_data$dummy_Renixx)
```

```{r}
set.seed(123)
seeds <- vector(mode = "list", length = 500)
for(i in 1:499) seeds[[i]] <- sample.int(1000, 15)
seeds[[500]] <- sample.int(1000, 1)
tuneLength.num <- 15
myTimeControl <- trainControl(method = "timeslice",
                              initialWindow = 125,
                              horizon = 12,
                              fixedWindow = FALSE,
                              allowParallel = TRUE,
                              seeds = seeds)

glmnet.mod <- train(dummy_Renixx ~.,
                    data = train.data_new,
                    method = "glmnet",
                    family = "binomial",
                    trControl = myTimeControl,
                    tuneLength=tuneLength.num)
glmnet.mod
```

```{r}
# Find the best lambda using cross-validation
#glmnet.mod$results$lambda
#cv.lasso <- cv.glmnet(x, y, alpha = 1, family = "binomial")
# Fit the final model on the training data
model <- glmnet(x, y, alpha = glmnet.mod$bestTune$alpha, family = "binomial",
                lambda =glmnet.mod$bestTune$lambda)
# Display regression coefficients
coef(model)
# Make predictions on the test data
x.test <- model.matrix(dummy_Renixx ~., vali.data)[,-1]
probabilities <- model %>% predict(newx = x.test)
predicted.classes <- ifelse(probabilities > 0.5, 1, 0)
# Model accuracy
observed.classes <- vali.data$dummy_Renixx
mean(predicted.classes == observed.classes)
plot_glmnet(cv.lasso$glmnet.fit, label=TRUE)
confusionMatrix(as.factor(predicted.classes[,1]), observed.classes)
```

```{r}
#cv.lasso$lambda.1se
#coef(cv.lasso, cv.lasso$lambda.1se)
#Finance$Renixxlag<-lag(Finance$Renixx)
#Finance$MSCIlag<-lag(MSCI_m$Rate_ms)
#Finance$Merge<-format(as.Date(Finance$Month), "%Y-%m")
#Climate$Merge<-format(as.Date(Climate$Date), "%Y-%m")

#Data<-merge(Finance,Climate[,c(1:7,14)],by="Merge")
#Data<- Data[c(6:216),-c(1,10)]
#rownames(Data) <- NULL

#cor(Data_FA$Factor_climate,Data_FA$OFR,method='kendal')
#round(fit$loadings[1:10,],2)
#cor(Data_FA$Factor_climate,Data_FA$Renixx,method='kendal')
#cor(Data_FA$Factor_finance,Data_FA$Renixx,method='kendal')
#cor(Data_FA$Factor_climate[c(1:133)],Data_FA$Renixx[c(1:133)],method='kendal')
#cor(Data_FA$Factor_finance[c(1:133)],Data_FA$Renixx[c(1:133)],method='kendal')
#cor(Data_FA$Factor_climate[c(134:177)],Data_FA$Renixx[c(134:177)],method='kendal'#)
#cor(Data_FA$Factor_finance[c(134:177)],Data_FA$Renixx[c(134:177)],method='kendal'#)
#cor(Data_FA$Factor_climate[c(178:215)],Data_FA$Renixx[c(178:215)],method='kendal'#)
#cor(Data_FA$Factor_finance[c(178:215)],Data_FA$Renixx[c(178:215)],method='kendal'#)
#cor(Data_FA$Factor_finance,Data_FA$OFR,method='kendal')
#"2016-02-29""2019-12-09"
#Data_2$dummy_Renixx <- as.factor(ifelse(Data_2$Month >= "2016-03-01" & #Data_2$Month <= "2019-10-01", 0,ifelse(Data_2$Month > "2005-01-01" & #Data_2$Month <= "2016-03-01"| Data_2$Month > "2019-10-01", 1,1)))
#Data_2$EPUlag<-lag(Data_or$EPU)[2:216]
#Data_2$OFRlag<-lag(Data_or$OFR)[2:216]
#Data_2$Climatelag<-scale(as.numeric(Energy_i[12:227,3]),center = TRUE,scale=TRUE)[2:216]
#Data_2$Warminglag<-scale(as.numeric(global_w[12:227,3]),center = TRUE,scale=TRUE)[2:216]
#Data_2$Naturallag<-scale(as.numeric(Natural[12:227,3]),center = TRUE,scale=TRUE)[2:216]
#Data_2$Green_elag<-scale(as.numeric(green_e[12:227,3]),center = TRUE,scale=TRUE)[2:216]
#Data_2$Carbon_plag<-scale(as.numeric(Carbon_p[12:227,3]),center = TRUE,scale=TRUE)[2:216]
#Data_2$Techlag<-scale(as.numeric(tech_d[12:227,3]),center = TRUE,scale=TRUE)[2:216]

# Model accuracy
#observed.classes <- vali.data$dummy_Renixx
#mean(predicted.classes == observed.classes)

#confusionMatrix(as.factor(predicted.classes[,1]), observed.classes)
# Find the best lambda using cross-validation
#glmnet.mod$results$lambda
#cv.lasso <- cv.glmnet(x, y, alpha = 1, family = "binomial")

#set.seed(123)
#cv.lasso <- cv.glmnet(x, y, alpha = 1, family = "binomial")
#plot(cv.lasso)
#cv.lasso$lambda.min
#cv.lasso$lambda.1se
#coef(cv.lasso, cv.lasso$lambda.min)
#coef(cv.lasso, cv.lasso$lambda.1se)
#lasso.model <- glmnet(x, y, alpha = 1, family = "binomial",
#                      lambda = cv.lasso$lambda.min)
## Make prediction on test data
#x.test <- model.matrix(dummy_Renixx ~., vali.data)[,-1]
#probabilities <- lasso.model %>% predict(newx = x.test)
#predicted.classes <- ifelse(probabilities > 0.5, 1, 0)
## Model accuracy
#observed.classes <- vali.data$dummy_Renixx
#mean(predicted.classes == observed.classes)

#fit XGBoost model and display training and testing data at each iteartion
#xgb.train(data = xgb_train, max.depth = 2, watchlist=watchlist, nrounds = 1000)

#impresp <- irf(var_all)
#plot(impresp)
#impresp <- irf(fitvar1)
#plot(impresp)

#plot(fevd(fitvar1))
#fevd(fitvar1)
#for (i in c(2,3,4,5)){
#Finance_2[,i]<-log(Finance_2[,i])
#}

#for (i in c(2:11)){
#Data_or[,i]<-log(Data_or[,i])
#}
#rownames(Data_VECM) <- NULL
#Data_or$Energy_i<-scale(Energy_i$Absolute.Google.Search.Volume[13:228],center = #TRUE,scale=TRUE)
#Data_or$Energy_s<-scale(Energy_s$Absolute.Google.Search.Volume[13:228],center = TRUE,scale=TRUE)

#Climate$Green_elag<-scale(as.numeric(green_e[12:227,3]),center = TRUE,scale=TRUE)
#Climate$Techlag<-scale(as.numeric(tech_d[12:227,3]),center = TRUE,scale=TRUE)
#Energy_s <- read.csv("~/GitHub/PhD-Thesis/Poject paper 1/Energy_stock.csv", #header=TRUE, comment.char="#")
#Energy_i$Absolute.Google.Search.Volume<-c(Energy_s$Absolute.Google.Search.Volume+Energy_i$Absolute.Google.Search.Volume)
#Energy_s$Rate<-c(0,diff(log(Energy_s$Absolute.Google.Search.Volume)))
#Climate$Energy_s<-Energy_s[13:228,4]
#Energy_i$Rate<-c(0,diff(log(Energy_i$Absolute.Google.Search.Volume)))
#Climate$Energy_i<-Energy_i[13:228,4]
#Climate$Energy_ilag<-scale(as.numeric(Energy_i[12:227,3]),center = TRUE,scale=TRUE) 
#Climate$Warminglag<-scale(as.numeric(global_w[12:227,3]),center = TRUE,scale=TRUE)
#Climate$Naturallag<-scale(as.numeric(Natural[12:227,3]),center = TRUE,scale=TRUE)
#Climate$Carbon_plag<-scale(as.numeric(Carbon_p[12:227,3]),center = TRUE,scale=TRUE)
```

```{r}
all_series<-ts(Data_VECM[,c('Renixx','Energy_n')],start=c(2005,1), end=c(2022,12),frequency =12)

var <- VARselect(all_series, type = "both", lag.max = 12, season = 12)
var$selection["AIC(n)"] #no-passed test
#c('EPU','Geo_i','dummy_Renixx','dummy_Renixx2','Tech','Natural','OFR','Carbon_p','Warming','Green_e')
fitvar1 = VAR(all_series,6, season = 12,type = 'both') #8 to pass all tests
#summary(fitvar1)
summary(fitvar1)
causality(fitvar1,cause = 'Energy_n')
```

```{r}
res<-matrix(c(fitvar1[["varresult"]][["Renixx"]][["residuals"]],fitvar1[["varresult"]][["Energy_i"]][["residuals"]]), ncol = 2)
mvshapiro_test(res)

#plot(fitvar1)
vars::arch.test(fitvar1,multivariate.only = TRUE)   
normality.test(fitvar1,multivariate.only = TRUE)  
serial.test(fitvar1, type = "BG",lags.bg = 12)
plot(stability(fitvar1), nc = 2)
```

```{r}
#Restricted VAR with exogenous variables
var_all = VAR(all_series,12, season = 12,type = 'both',exogen = Data_VECM[,c('dummy_OFR')])

var_all<-restrict(var_all, method = "ser")
summary(var_all)

res<-matrix(c(var_all[["varresult"]][["Renixx"]][["residuals"]],var_all[["varresult"]][["Energy_i"]][["residuals"]]), ncol = 2)
mvshapiro_test(res)

#plot(var_all)
vars::arch.test(var_all,multivariate.only = TRUE)   
normality.test(var_all,multivariate.only = TRUE)  
serial.test(var_all, type = "BG",lags.bg = 12)
plot(stability(var_all), nc = 2)
```

```{r}
#Johansen-test
nlags <- 6-1

jotest_all=ca.jo(all_series, type="eigen", K=nlags, ecdet="trend", spec= "transitory", season = 12)
summary(jotest_all)
jotest_all=ca.jo(all_series, type="trace", K=nlags, ecdet="trend", spec= "transitory", season = 12)
summary(jotest_all)
```
